{% extends "base.html" %}

{% block head %}
<style>
    /* --- Metric Tabs --- */
    .metric-tab {
        transition: all 0.2s ease;
        position: relative;
    }
    .metric-tab.active {
        background: #f0b429;
        color: #0f0f23;
        border-color: #f0b429;
        font-weight: 600;
    }
    .metric-tab:not(.active):hover {
        border-color: #f0b429;
        color: #f0b429;
    }

    /* --- Province Paths --- */
    .province-path {
        stroke: #5a5a7e;
        stroke-width: 1.2;
        cursor: pointer;
        transition: filter 0.15s ease;
    }
    .province-path:hover {
        stroke: #00D9FF;
        stroke-width: 2;
        filter: brightness(1.3);
    }
    .province-path.selected {
        stroke: #f0b429;
        stroke-width: 2.5;
    }

    /* --- Glow filter sizes --- */
    .province-path.glow-high { filter: drop-shadow(0 0 6px rgba(240,180,41,0.4)); }
    .province-path.glow-mid  { filter: drop-shadow(0 0 3px rgba(13,115,119,0.3)); }
    .province-path:hover { filter: brightness(1.3) drop-shadow(0 0 8px rgba(0,217,255,0.4)); }

    /* --- Tooltip --- */
    .map-tooltip {
        position: fixed;
        pointer-events: none;
        background: #1a1a2e;
        border: 1px solid #3a3a5e;
        border-radius: 8px;
        padding: 10px 14px;
        font-size: 13px;
        opacity: 0;
        transition: opacity 0.15s ease;
        z-index: 100;
        box-shadow: 0 4px 24px rgba(0,0,0,0.5), 0 0 12px rgba(0,217,255,0.1);
        min-width: 180px;
    }
    .map-tooltip.visible { opacity: 1; }

    /* --- Side Panel --- */
    #side-panel {
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    #side-panel.closed {
        transform: translateX(100%);
    }
    #panel-backdrop {
        transition: opacity 0.3s ease;
        pointer-events: none;
    }
    #panel-backdrop.active {
        opacity: 1;
        pointer-events: all;
    }

    /* --- Rankings Table --- */
    .rank-row {
        transition: background 0.12s ease;
    }
    .rank-row:hover {
        background: #1a1a2e;
    }
    .rank-row.highlighted {
        background: #16213e;
        border-left: 3px solid #00D9FF;
    }
    .rank-row.tier-gold td:first-child { color: #f0b429; font-weight: 700; }
    .rank-row.tier-silver td:first-child { color: #a0a0b8; font-weight: 600; }

    /* --- Stat Cards --- */
    .stat-card {
        background: #1a1a2e;
        border: 1px solid #2a2a3e;
        border-radius: 8px;
        padding: 12px 16px;
        min-width: 160px;
    }
    .stat-card .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        line-height: 1.2;
    }
    .stat-card .stat-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
    }

    /* --- Cluster annotations --- */
    .cluster-label {
        font-size: 10px;
        fill: #8888aa;
        font-weight: 500;
        pointer-events: none;
        text-anchor: middle;
        letter-spacing: 0.05em;
        paint-order: stroke;
        stroke: #0f0f23;
        stroke-width: 3px;
        stroke-linejoin: round;
    }

    /* --- Province labels --- */
    .province-label {
        font-size: 8px;
        fill: #c0c0d0;
        pointer-events: none;
        text-anchor: middle;
        dominant-baseline: central;
        paint-order: stroke;
        stroke: #0f0f23;
        stroke-width: 2.5px;
        stroke-linejoin: round;
    }

    /* --- Metric summary bar --- */
    .metric-summary {
        transition: opacity 0.3s ease;
    }

    /* --- Responsive --- */
    @media (max-width: 768px) {
        #side-panel {
            width: 100% !important;
            bottom: 0;
            top: auto !important;
            height: 70vh !important;
            border-left: none !important;
            border-top: 1px solid #2a2a3e;
            border-radius: 12px 12px 0 0;
        }
        #side-panel.closed {
            transform: translateY(100%);
        }
        .stat-card { min-width: 120px; padding: 8px 12px; }
        .stat-card .stat-value { font-size: 1.1rem; }
        #rankings-section table { font-size: 12px; }
    }

    /* --- Mini bar in rankings --- */
    .mini-metric-bar {
        display: inline-block;
        height: 3px;
        border-radius: 2px;
        vertical-align: middle;
        opacity: 0.3;
        transition: opacity 0.15s;
    }
    .mini-metric-bar.active-metric {
        opacity: 1;
        height: 5px;
    }

    /* --- Layout view tabs --- */
    .view-tab {
        border: 1px solid #2a2a3e;
        color: #8888aa;
        background: transparent;
        transition: all 0.2s ease;
    }
    .view-tab:hover {
        border-color: #f0b429;
        color: #f0b429;
    }
    .view-tab.active {
        border-color: #f0b429;
        color: #0f0f23;
        background: #f0b429;
        font-weight: 600;
    }

    /* --- Fab entities table --- */
    .fab-row {
        transition: background 0.12s ease;
    }
    .fab-row:hover {
        background: #1a1a2e;
    }

    /* --- Story strip --- */
    #stories-strip .story-tag {
        border: 1px solid #2a2a3e;
        color: #00D9FF;
        background: #16213e;
    }

</style>
{% endblock %}

{% block content %}
<div class="relative" id="app-root">
    <div class="px-6 pt-4 pb-1" id="stories-strip" style="display:none;">
        <div class="bg-sa-card rounded-lg border border-sa-border px-4 py-3 flex flex-wrap items-start gap-3">
            <div class="min-w-0 flex-1">
                <div class="text-[11px] uppercase tracking-wider text-sa-muted mb-1">
                    Strategic Storyline <span id="story-position"></span>
                </div>
                <div class="text-white font-semibold text-sm" id="story-headline"></div>
                <div class="text-sa-cyan text-xs mt-1" id="story-province"></div>
                <p class="text-sa-muted text-xs mt-1.5 leading-relaxed" id="story-body"></p>
                <div class="mt-2 flex flex-wrap gap-1.5" id="story-tags"></div>
            </div>
            <div class="flex items-center gap-1.5">
                <button id="story-prev" class="text-xs px-2.5 py-1 rounded border border-sa-border text-sa-muted hover:text-sa-gold hover:border-sa-gold">Prev</button>
                <button id="story-next" class="text-xs px-2.5 py-1 rounded border border-sa-border text-sa-muted hover:text-sa-gold hover:border-sa-gold">Next</button>
                <button id="story-open" class="text-xs px-2.5 py-1 rounded border border-sa-gold text-sa-gold hover:bg-sa-gold hover:text-sa-bg">Open Province</button>
            </div>
        </div>
    </div>

    <!-- Storytelling Stat Cards -->
    <div class="px-6 pt-4 pb-2 flex flex-wrap gap-3" id="stat-cards">
        <div class="stat-card">
            <div class="stat-value text-sa-gold" id="sc-primary">--</div>
            <div class="stat-label text-sa-muted" id="sc-primary-label">Primary Metric Total</div>
        </div>
        <div class="stat-card">
            <div class="stat-value text-sa-cyan" id="sc-fab-provinces">--</div>
            <div class="stat-label text-sa-muted">Provinces with Active Fabs</div>
        </div>
        <div class="stat-card">
            <div class="stat-value text-white" id="sc-top-province">--</div>
            <div class="stat-label text-sa-muted">Top Province (Score)</div>
        </div>
        <div class="stat-card">
            <div class="stat-value text-sa-coral" id="sc-secondary">--</div>
            <div class="stat-label text-sa-muted" id="sc-secondary-label">Secondary Indicator</div>
        </div>
    </div>

    <!-- Metric Tabs + Summary -->
    <div class="px-6 py-3 flex flex-wrap items-center gap-2" id="metric-tabs">
        <div class="flex flex-wrap items-center gap-2" id="metric-tab-buttons"></div>
        <div class="ml-3 metric-summary text-sm" id="metric-summary">
            <span class="text-sa-muted">National avg:</span>
            <span class="text-white font-semibold" id="metric-avg">--</span>
            <span class="text-sa-muted mx-1">|</span>
            <span class="text-sa-muted">Max:</span>
            <span class="text-sa-gold font-semibold" id="metric-max">--</span>
        </div>
        <div class="ml-auto inline-flex items-center gap-1.5 bg-sa-card/60 rounded-full px-1.5 py-1 border border-sa-border" id="view-tabs">
            <button class="view-tab active px-3 py-1 rounded-full text-xs" data-view="split">Split</button>
            <button class="view-tab px-3 py-1 rounded-full text-xs" data-view="map">Map</button>
            <button class="view-tab px-3 py-1 rounded-full text-xs" data-view="table">Table</button>
        </div>
    </div>

    <!-- Map + Panel Container -->
    <div class="relative" id="map-panel-wrap" style="height: calc(100vh - 200px); min-height: 500px; overflow: hidden;">
        <!-- Map -->
        <div id="map-container" style="position: relative; width: 100%; height: 100%; overflow: hidden;">
            <svg id="china-map" style="display: block;"></svg>

            <!-- Legend -->
            <div class="absolute bottom-4 left-6 flex items-center gap-2 bg-sa-card/80 backdrop-blur rounded-lg px-3 py-2 border border-sa-border">
                <span class="text-xs text-sa-muted" id="legend-label">Low</span>
                <div id="legend-bar" class="h-3 rounded" style="width: 140px;"></div>
                <span class="text-xs text-sa-muted" id="legend-max-label">High</span>
            </div>

            <!-- Tooltip -->
            <div class="map-tooltip" id="tooltip">
                <div class="flex items-center justify-between mb-1">
                    <span class="text-white font-semibold text-sm" id="tt-name"></span>
                    <span class="text-sa-muted text-xs" id="tt-cn"></span>
                </div>
                <div class="flex items-center justify-between mb-1.5">
                    <span class="text-sa-cyan text-sm font-medium" id="tt-value"></span>
                    <span class="text-sa-muted text-xs" id="tt-rank"></span>
                </div>
                <div class="w-full bg-sa-bg rounded-full h-1.5 mt-1">
                    <div class="rounded-full h-1.5 transition-all" id="tt-bar" style="width:0%; background: #00D9FF;"></div>
                </div>
            </div>
        </div>

        <!-- Panel backdrop -->
        <div id="panel-backdrop" class="absolute inset-0 bg-black/30 opacity-0 z-10" onclick="window.closePanel()"></div>

        <!-- Side Panel -->
        <div id="side-panel" class="closed w-[420px] border-l border-sa-border bg-sa-card overflow-y-auto absolute right-0 top-0 z-20" style="height: 100%; max-height: calc(100vh - 200px);"></div>
    </div>

    <!-- Rankings Table -->
    <div class="px-6 py-6" id="rankings-section">
        <h3 class="text-sm font-semibold text-sa-muted uppercase tracking-wider mb-3">
            Province Rankings — <span id="ranking-metric-label">Overall Score</span>
        </h3>
        <div class="bg-sa-card rounded-lg border border-sa-border overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="sticky top-0 bg-sa-card z-10">
                        <tr id="rankings-header-row" class="border-b border-sa-border text-sa-muted text-xs uppercase tracking-wider"></tr>
                    </thead>
                    <tbody id="rankings-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Fab Entities Table -->
    <div class="px-6 pb-8" id="entities-section">
        <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
            <h3 class="text-sm font-semibold text-sa-muted uppercase tracking-wider">
                Fab Entity List
                <span class="normal-case text-xs text-sa-cyan ml-1" id="fab-entity-count"></span>
            </h3>
            <div class="flex flex-wrap items-center gap-2">
                <input
                    id="fab-search"
                    type="text"
                    placeholder="Search fab, province, node..."
                    class="bg-sa-card border border-sa-border rounded-md px-3 py-1.5 text-xs text-white placeholder-sa-muted outline-none focus:border-sa-cyan"
                />
                <select
                    id="fab-status-filter"
                    class="bg-sa-card border border-sa-border rounded-md px-2.5 py-1.5 text-xs text-white outline-none focus:border-sa-cyan"
                >
                    <option value="">All Statuses</option>
                </select>
                <select
                    id="fab-sort"
                    class="bg-sa-card border border-sa-border rounded-md px-2.5 py-1.5 text-xs text-white outline-none focus:border-sa-cyan"
                >
                    <option value="capacity_desc">Capacity ↓</option>
                    <option value="capacity_asc">Capacity ↑</option>
                    <option value="name_asc">Name A-Z</option>
                    <option value="province_asc">Province A-Z</option>
                    <option value="status_asc">Status</option>
                </select>
            </div>
        </div>
        <div class="bg-sa-card rounded-lg border border-sa-border overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="sticky top-0 bg-sa-card z-10">
                        <tr class="border-b border-sa-border text-sa-muted text-xs uppercase tracking-wider">
                            <th class="px-4 py-2.5 text-left w-12">#</th>
                            <th class="px-4 py-2.5 text-left">Fab</th>
                            <th class="px-4 py-2.5 text-left">Province</th>
                            <th class="px-4 py-2.5 text-left">Node</th>
                            <th class="px-4 py-2.5 text-center">Status</th>
                            <th class="px-4 py-2.5 text-right">Capacity (KWPM)</th>
                            <th class="px-4 py-2.5 text-left">Sector</th>
                        </tr>
                    </thead>
                    <tbody id="fab-entities-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    let provinceData = {};
    let activeMetric = 'composite_score';
    let metricKeys = [];
    let metricMeta = {};
    let selectedAdcode = null;
    let paths, labelGroup, clusterGroup;
    let colorScale;
    let sortedProvinces = []; // for keyboard nav
    let fabEntities = [];
    let topStories = [];
    let activeStoryIndex = 0;
    let storyTimer = null;
    let focusIndex = -1;
    let activeView = 'split';

    const svg = d3.select('#china-map');
    const tooltip = document.getElementById('tooltip');
    const panel = document.getElementById('side-panel');
    const backdrop = document.getElementById('panel-backdrop');
    const mapPanelWrap = document.getElementById('map-panel-wrap');
    const rankingsSection = document.getElementById('rankings-section');
    const entitiesSection = document.getElementById('entities-section');
    const fabSearchInput = document.getElementById('fab-search');
    const fabStatusFilter = document.getElementById('fab-status-filter');
    const fabSortSelect = document.getElementById('fab-sort');
    const storiesStrip = document.getElementById('stories-strip');
    const storyPosition = document.getElementById('story-position');
    const storyHeadline = document.getElementById('story-headline');
    const storyProvince = document.getElementById('story-province');
    const storyBody = document.getElementById('story-body');
    const storyTags = document.getElementById('story-tags');
    const storyPrevBtn = document.getElementById('story-prev');
    const storyNextBtn = document.getElementById('story-next');
    const storyOpenBtn = document.getElementById('story-open');

    function setView(view) {
        activeView = view;
        document.querySelectorAll('.view-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.view === view);
        });

        if (view === 'map') {
            mapPanelWrap.style.display = 'block';
            rankingsSection.style.display = 'none';
            entitiesSection.style.display = 'none';
            return;
        }
        if (view === 'table') {
            mapPanelWrap.style.display = 'none';
            rankingsSection.style.display = 'block';
            entitiesSection.style.display = 'block';
            window.closePanel();
            return;
        }

        mapPanelWrap.style.display = 'block';
        rankingsSection.style.display = 'block';
        entitiesSection.style.display = 'none';
    }

    const knownMetricOrderSets = [
        ['composite_score', 'fab_capacity', 'ai_compute_power', 'gov_subsidies', 'stem_graduates', 'tech_gdp_share'],
        ['composite_score', 'ic_revenue', 'computing_power', 'gov_investment', 'rd_intensity', 'power_price'],
    ];

    const shortLabelMap = {
        composite_score: 'Score',
        fab_capacity: 'Fabs',
        ai_compute_power: 'AI',
        gov_subsidies: 'Gov',
        stem_graduates: 'STEM',
        tech_gdp_share: 'GDP%',
        ic_revenue: 'IC Rev',
        computing_power: 'Compute',
        gov_investment: 'Gov Inv',
        rd_intensity: 'R&D',
        power_price: 'Power',
    };

    function defaultLabelFromKey(key) {
        return key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    }

    function makeValueFormatter(unit) {
        if (unit === 'pct') return v => v + '%';
        if (unit === 'B_CNY') return v => '\u00a5' + v + 'B';
        if (unit === 'kwpm') return v => v + 'K';
        if (unit === 'annual') return v => Math.round(v).toLocaleString();
        if (unit === 'MW') return v => v + ' MW';
        if (unit === 'CNY/kWh') return v => '\u00a5' + v + '/kWh';
        return v => (Number.isFinite(Number(v)) ? Number(v).toLocaleString() : String(v));
    }

    function buildMetricModel() {
        const provinces = Object.values(provinceData);
        const firstProvince = provinces.find(p => p && p.metrics && typeof p.metrics === 'object');
        if (!firstProvince) {
            metricKeys = ['composite_score'];
            metricMeta = {
                composite_score: { key: 'composite_score', label: 'Overall Score', short: 'Score', unit: 'index', format: v => v.toString() },
            };
            activeMetric = 'composite_score';
            return;
        }

        const available = Object.keys(firstProvince.metrics).filter(k =>
            provinces.some(p => p?.metrics?.[k] && Number.isFinite(Number(p.metrics[k].value)))
        );

        let ordered = knownMetricOrderSets.find(set => set.every(k => available.includes(k))) || [];
        if (!ordered.length) {
            ordered = available.slice();
            if (ordered.includes('composite_score')) {
                ordered = ['composite_score', ...ordered.filter(k => k !== 'composite_score')];
            }
        }
        if (!ordered.length) ordered = Object.keys(firstProvince.metrics);

        metricKeys = ordered.slice(0, 6);
        metricMeta = {};
        metricKeys.forEach(k => {
            const sample = provinces.find(p => p?.metrics?.[k])?.metrics?.[k] || {};
            const label = sample.label || defaultLabelFromKey(k);
            const short = shortLabelMap[k] || label.split(' ')[0] || label;
            const unit = sample.unit || '';
            metricMeta[k] = { key: k, label, short, unit, format: makeValueFormatter(unit) };
        });
        activeMetric = metricKeys.includes('composite_score') ? 'composite_score' : metricKeys[0];
    }

    function renderMetricTabs() {
        const container = document.getElementById('metric-tab-buttons');
        container.innerHTML = metricKeys.map((k, i) => {
            const activeClass = k === activeMetric ? 'active' : 'text-sa-muted';
            return '<button class="metric-tab ' + activeClass + ' px-4 py-1.5 rounded-full text-sm border border-sa-border" ' +
                'data-metric="' + k + '" data-index="' + (i + 1) + '">' + escapeHtml(metricMeta[k].label) + '</button>';
        }).join('');

        document.querySelectorAll('.metric-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.metric-tab').forEach(t => {
                    t.classList.remove('active');
                    t.classList.add('text-sa-muted');
                });
                tab.classList.add('active');
                tab.classList.remove('text-sa-muted');
                activeMetric = tab.dataset.metric;
                recolor(true);
                buildRankings();
            });
        });
    }

    function renderRankingsHeader() {
        const row = document.getElementById('rankings-header-row');
        const metricHeaders = metricKeys.map(k =>
            '<th class="px-4 py-2.5 text-center" title="' + escapeHtml(metricMeta[k].label) + '">' +
            escapeHtml(metricMeta[k].short) + '</th>'
        ).join('');
        row.innerHTML =
            '<th class="px-4 py-2.5 text-left w-12">#</th>' +
            '<th class="px-4 py-2.5 text-left">Province</th>' +
            '<th class="px-4 py-2.5 text-left">Region</th>' +
            metricHeaders +
            '<th class="px-4 py-2.5 text-right w-40">Active Metric</th>';
    }

    // Custom SA color scale: visible navy -> teal -> gold -> coral
    // Floor color (#1a2e4a) must be visually distinct from page background (#0f0f23)
    const saColorInterpolator = (function() {
        const colors = ['#1a2e4a', '#0d5f6a', '#0d7377', '#3a9a5c', '#a8b840', '#f0b429', '#ff6b35'];
        const scale = d3.scaleLinear()
            .domain(colors.map((_, i) => i / (colors.length - 1)))
            .range(colors)
            .interpolate(d3.interpolateRgb);
        return t => scale(Math.max(0, Math.min(1, t)));
    })();

    function metricValue(province, metric) {
        return Number(province?.metrics?.[metric]?.value) || 0;
    }

    function makeColorScale(metric) {
        const values = Object.values(provinceData).map(p => metricValue(p, metric));
        const max = Math.max(...values) || 1;
        return v => saColorInterpolator(v / max);
    }

    function fmtValue(adcode, metric) {
        const p = provinceData[adcode];
        if (!p || !metricMeta[metric]) return '';
        return metricMeta[metric].format(metricValue(p, metric));
    }

    function getMaxValue(metric) {
        return Math.max(...Object.values(provinceData).map(p => metricValue(p, metric))) || 1;
    }

    // Compute rank for a province on active metric
    function getRank(adcode) {
        const sorted = Object.entries(provinceData)
            .sort((a, b) => metricValue(b[1], activeMetric) - metricValue(a[1], activeMetric));
        const idx = sorted.findIndex(([ac]) => ac === adcode);
        return idx >= 0 ? idx + 1 : null;
    }

    function escapeHtml(value) {
        return String(value ?? '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function getStatusBadgeClass(status) {
        if (status === 'Operating') return 'bg-green-900/40 text-green-400 border border-green-500/30';
        if (status === 'Under Construction') return 'bg-yellow-900/40 text-yellow-400 border border-yellow-500/30';
        if (status === 'Ramping') return 'bg-blue-900/40 text-blue-400 border border-blue-500/30';
        if (status === 'Pilot') return 'bg-purple-900/40 text-purple-400 border border-purple-500/30';
        if (status === 'Suspended') return 'bg-red-900/40 text-red-400 border border-red-500/30';
        return 'bg-sa-navy text-sa-cyan border border-sa-cyan/30';
    }

    function statusSortRank(status) {
        const order = {
            Operating: 1,
            Ramping: 2,
            Pilot: 3,
            'Under Construction': 4,
            Suspended: 5,
        };
        return order[status] || 99;
    }

    function buildFabEntities() {
        fabEntities = Object.entries(provinceData).flatMap(([adcode, province]) =>
            (province.fabs || []).map((fab, index) => ({
                id: adcode + '_' + index,
                adcode,
                province_en: province.name_en,
                province_cn: province.name_cn,
                region: province.region,
                name: fab.name || 'Unknown Fab',
                node: fab.node || 'N/A',
                capacity_kwpm: Number(fab.capacity_kwpm) || 0,
                status: fab.status || 'Unknown',
                sector: fab.sector || 'N/A',
            }))
        );
    }

    function buildTopStories() {
        topStories = Object.entries(provinceData).flatMap(([adcode, province]) =>
            (province.top_stories || []).map((story, idx) => ({
                id: adcode + '_' + idx,
                adcode,
                headline: story.headline || 'Untitled Story',
                body: story.body || '',
                tags: Array.isArray(story.tags) ? story.tags : [],
                province_en: province.name_en || adcode,
                province_cn: province.name_cn || '',
                story_order: idx,
                score: metricValue(province, 'composite_score'),
            }))
        );
        topStories.sort((a, b) => (b.score - a.score) || (a.story_order - b.story_order));
    }

    function renderStory(index) {
        if (!topStories.length) {
            storiesStrip.style.display = 'none';
            return;
        }
        storiesStrip.style.display = 'block';
        activeStoryIndex = ((index % topStories.length) + topStories.length) % topStories.length;
        const story = topStories[activeStoryIndex];

        storyPosition.textContent = '(' + (activeStoryIndex + 1) + '/' + topStories.length + ')';
        storyHeadline.textContent = story.headline;
        storyProvince.textContent = story.province_en + (story.province_cn ? ' · ' + story.province_cn : '');
        storyBody.textContent = story.body;
        storyTags.innerHTML = story.tags.map(tag =>
            '<span class="story-tag text-[11px] px-2 py-0.5 rounded-full">' + escapeHtml(tag) + '</span>'
        ).join('');
    }

    function startStoryRotation() {
        if (storyTimer) {
            clearInterval(storyTimer);
            storyTimer = null;
        }
        if (topStories.length > 1) {
            storyTimer = setInterval(() => renderStory(activeStoryIndex + 1), 9000);
        }
    }

    function populateFabStatusFilter() {
        const statuses = Array.from(new Set(fabEntities.map(f => f.status))).sort();
        fabStatusFilter.innerHTML = '<option value="">All Statuses</option>' +
            statuses.map(s => '<option value="' + escapeHtml(s) + '">' + escapeHtml(s) + '</option>').join('');
    }

    function buildFabEntityTable() {
        const query = (fabSearchInput.value || '').trim().toLowerCase();
        const status = fabStatusFilter.value || '';
        const sortBy = fabSortSelect.value || 'capacity_desc';

        let rows = fabEntities.filter(f => {
            const matchesStatus = !status || f.status === status;
            if (!matchesStatus) return false;
            if (!query) return true;
            const haystack = [
                f.name,
                f.province_en,
                f.province_cn,
                f.region,
                f.node,
                f.status,
                f.sector,
            ].join(' ').toLowerCase();
            return haystack.includes(query);
        });

        rows = rows.slice().sort((a, b) => {
            if (sortBy === 'capacity_asc') return a.capacity_kwpm - b.capacity_kwpm;
            if (sortBy === 'name_asc') return a.name.localeCompare(b.name);
            if (sortBy === 'province_asc') return a.province_en.localeCompare(b.province_en);
            if (sortBy === 'status_asc') {
                const byStatus = statusSortRank(a.status) - statusSortRank(b.status);
                return byStatus || (b.capacity_kwpm - a.capacity_kwpm);
            }
            return b.capacity_kwpm - a.capacity_kwpm;
        });

        document.getElementById('fab-entity-count').textContent =
            rows.length + ' / ' + fabEntities.length + ' shown';

        const tbody = document.getElementById('fab-entities-body');
        tbody.innerHTML = rows.map((f, i) =>
            '<tr class="fab-row border-b border-sa-border/30 cursor-pointer" ' +
                'data-adcode="' + f.adcode + '" ' +
                'onmouseenter="window._highlightProvince(\'' + f.adcode + '\')" ' +
                'onmouseleave="window._unhighlightProvince(\'' + f.adcode + '\')" ' +
                'onclick="window._selectProvince(\'' + f.adcode + '\')">' +
                '<td class="px-4 py-2 text-sa-muted">' + (i + 1) + '</td>' +
                '<td class="px-4 py-2 text-white font-medium">' + escapeHtml(f.name) + '</td>' +
                '<td class="px-4 py-2 text-sa-muted text-xs">' +
                    escapeHtml(f.province_en) + ' <span class="opacity-70">' + escapeHtml(f.province_cn) + '</span></td>' +
                '<td class="px-4 py-2 text-sa-muted text-xs">' + escapeHtml(f.node) + '</td>' +
                '<td class="px-4 py-2 text-center">' +
                    '<span class="text-xs px-2 py-0.5 rounded-full ' + getStatusBadgeClass(f.status) + '">' +
                    escapeHtml(f.status) + '</span></td>' +
                '<td class="px-4 py-2 text-right text-sa-cyan font-medium">' + f.capacity_kwpm.toLocaleString() + '</td>' +
                '<td class="px-4 py-2 text-sa-muted text-xs">' + escapeHtml(f.sector) + '</td>' +
            '</tr>'
        ).join('');
    }

    // Update stat cards
    function updateStatCards() {
        const provinces = Object.values(provinceData);
        if (!provinces.length) return;

        const primaryEl = document.getElementById('sc-primary');
        const secondaryEl = document.getElementById('sc-secondary');
        const primaryLabelEl = document.getElementById('sc-primary-label');
        const secondaryLabelEl = document.getElementById('sc-secondary-label');

        // Provinces with active fabs
        const fabProvinces = provinces.filter(p => p.fabs && p.fabs.some(f => f.status === 'Operating')).length;
        document.getElementById('sc-fab-provinces').textContent = fabProvinces + '/31';

        if (metricKeys.includes('fab_capacity')) {
            const totalFab = provinces.reduce((s, p) => s + metricValue(p, 'fab_capacity'), 0);
            primaryEl.textContent = totalFab.toLocaleString();
            primaryLabelEl.textContent = 'Total Fab Capacity (KWPM)';

            const ucFabs = provinces.reduce((s, p) =>
                s + (p.fabs ? p.fabs.filter(f => f.status === 'Under Construction').length : 0), 0);
            secondaryEl.textContent = ucFabs;
            secondaryLabelEl.textContent = 'Fabs Under Construction';
        } else if (metricKeys.includes('ic_revenue')) {
            const totalIC = provinces.reduce((s, p) => s + metricValue(p, 'ic_revenue'), 0);
            primaryEl.textContent = '\u00a5' + Math.round(totalIC).toLocaleString() + 'B';
            primaryLabelEl.textContent = 'Total IC Revenue (B CNY)';

            const totalAI = provinces.reduce((s, p) =>
                s + (p.ai_compute ? Number(p.ai_compute.ai_companies || 0) : 0), 0);
            secondaryEl.textContent = totalAI.toLocaleString();
            secondaryLabelEl.textContent = 'Total AI Companies';
        } else {
            const primaryMetric = metricKeys[1] || metricKeys[0];
            const secondaryMetric = metricKeys[2] || metricKeys[0];
            const primaryTotal = provinces.reduce((s, p) => s + metricValue(p, primaryMetric), 0);
            const secondaryAvg = provinces.reduce((s, p) => s + metricValue(p, secondaryMetric), 0) / provinces.length;
            primaryEl.textContent = metricMeta[primaryMetric].format(Math.round(primaryTotal * 10) / 10);
            primaryLabelEl.textContent = 'Total ' + metricMeta[primaryMetric].label;
            secondaryEl.textContent = metricMeta[secondaryMetric].format(Math.round(secondaryAvg * 10) / 10);
            secondaryLabelEl.textContent = 'Avg ' + metricMeta[secondaryMetric].label;
        }

        // Top province
        const topMetric = metricKeys.includes('composite_score') ? 'composite_score' : metricKeys[0];
        const top = Object.entries(provinceData)
            .sort((a, b) => metricValue(b[1], topMetric) - metricValue(a[1], topMetric))[0];
        if (top) {
            document.getElementById('sc-top-province').textContent =
                top[1].name_en + ' (' + metricMeta[topMetric].format(metricValue(top[1], topMetric)) + ')';
        }
    }

    // Update metric summary
    function updateMetricSummary() {
        if (!metricMeta[activeMetric]) return;
        const values = Object.values(provinceData).map(p => metricValue(p, activeMetric));
        if (!values.length) return;
        const avg = values.reduce((a, b) => a + b, 0) / values.length;
        const max = Math.max(...values);
        document.getElementById('metric-avg').textContent = metricMeta[activeMetric].format(Math.round(avg * 10) / 10);
        document.getElementById('metric-max').textContent = metricMeta[activeMetric].format(max);
    }

    // Update legend
    function updateLegend() {
        if (!metricMeta[activeMetric]) return;
        const max = getMaxValue(activeMetric);
        const bar = document.getElementById('legend-bar');
        const stops = [];
        for (let i = 0; i <= 10; i++) {
            const t = i / 10;
            stops.push(saColorInterpolator(t) + ' ' + (t * 100) + '%');
        }
        bar.style.background = 'linear-gradient(to right, ' + stops.join(', ') + ')';
        document.getElementById('legend-label').textContent = '0';
        document.getElementById('legend-max-label').textContent = metricMeta[activeMetric].format(max);
    }

    // Recolor map
    function recolor(transition) {
        colorScale = makeColorScale(activeMetric);
        const sel = transition ? paths.transition().duration(400).ease(d3.easeCubicOut) : paths;
        sel.attr('fill', d => {
            const adcode = String(d.properties.adcode);
            const p = provinceData[adcode];
            return p ? colorScale(metricValue(p, activeMetric)) : '#141e30';
        });

        // Update glow classes
        const max = getMaxValue(activeMetric);
        paths.each(function(d) {
            const adcode = String(d.properties.adcode);
            const p = provinceData[adcode];
            const el = d3.select(this);
            el.classed('glow-high', false).classed('glow-mid', false);
            if (p) {
                const ratio = metricValue(p, activeMetric) / max;
                if (ratio > 0.7) el.classed('glow-high', true);
                else if (ratio > 0.4) el.classed('glow-mid', true);
            }
        });

        updateLegend();
        updateMetricSummary();
    }

    // Build rankings table
    function buildRankings() {
        if (!activeMetric || !metricMeta[activeMetric] || !metricKeys.length) return;
        const allMetricMaxes = {};
        metricKeys.forEach(k => {
            allMetricMaxes[k] = getMaxValue(k);
        });

        const sorted = Object.entries(provinceData)
            .sort((a, b) => metricValue(b[1], activeMetric) - metricValue(a[1], activeMetric));
        sortedProvinces = sorted.map(([ac]) => ac);

        document.getElementById('ranking-metric-label').textContent = metricMeta[activeMetric].label;

        const tbody = document.getElementById('rankings-body');
        tbody.innerHTML = sorted.map(([adcode, p], i) => {
            const v = metricValue(p, activeMetric);
            const max = allMetricMaxes[activeMetric];
            const pct = max > 0 ? (v / max * 100) : 0;
            const highlighted = adcode === selectedAdcode ? 'highlighted' : '';
            const tierClass = i < 5 ? 'tier-gold' : (i < 10 ? 'tier-silver' : '');

            // Mini bars for all metrics
            const miniBars = metricKeys.map(k => {
                const mv = metricValue(p, k);
                const mmax = allMetricMaxes[k];
                const mpct = mmax > 0 ? (mv / mmax * 100) : 0;
                const isActive = k === activeMetric;
                const color = isActive ? '#f0b429' : '#3a3a5e';
                return '<td class="px-4 py-2 text-center"><div class="w-full flex items-center justify-center" title="' +
                    metricMeta[k].label + ': ' + metricMeta[k].format(mv) + '">' +
                    '<div class="mini-metric-bar ' + (isActive ? 'active-metric' : '') +
                    '" style="width:' + Math.max(mpct, 2) + '%; background:' + color + '; max-width:40px;"></div></div></td>';
            });

            return '<tr class="rank-row border-b border-sa-border/30 cursor-pointer ' + highlighted + ' ' + tierClass + '"' +
                ' data-adcode="' + adcode + '"' +
                ' onmouseenter="window._highlightProvince(\'' + adcode + '\')"' +
                ' onmouseleave="window._unhighlightProvince(\'' + adcode + '\')"' +
                ' onclick="window._selectProvince(\'' + adcode + '\')">' +
                '<td class="px-4 py-2 text-sa-muted">' + (i + 1) + '</td>' +
                '<td class="px-4 py-2 text-white font-medium">' + p.name_en +
                ' <span class="text-sa-muted text-xs">' + p.name_cn + '</span></td>' +
                '<td class="px-4 py-2 text-sa-muted text-xs">' + p.region + '</td>' +
                miniBars.join('') +
                '<td class="px-4 py-2 text-right">' +
                '<div class="flex items-center justify-end gap-2">' +
                '<span class="text-sa-cyan font-medium">' + fmtValue(adcode, activeMetric) + '</span>' +
                '<div class="w-20 bg-sa-bg rounded-full h-1.5">' +
                '<div class="bg-sa-gold rounded-full h-1.5" style="width:' + pct + '%"></div>' +
                '</div></div></td></tr>';
        }).join('');
    }

    // Bidirectional highlighting: table row -> map path
    window._highlightProvince = function(adcode) {
        d3.selectAll('.province-path').filter(d => String(d.properties.adcode) === adcode)
            .raise()
            .attr('stroke', '#00D9FF')
            .attr('stroke-width', 2);
    };

    window._unhighlightProvince = function(adcode) {
        d3.selectAll('.province-path').filter(d => String(d.properties.adcode) === adcode)
            .attr('stroke', adcode === selectedAdcode ? '#f0b429' : '#5a5a7e')
            .attr('stroke-width', adcode === selectedAdcode ? 2.5 : 1.2);
    };

    // Open side panel
    function openPanel(adcode) {
        selectedAdcode = adcode;
        panel.classList.remove('closed');
        backdrop.classList.add('active');
        d3.selectAll('.province-path').classed('selected', false)
            .attr('stroke', '#5a5a7e').attr('stroke-width', 1.2);
        d3.selectAll('.province-path')
            .filter(d => String(d.properties.adcode) === adcode)
            .classed('selected', true)
            .attr('stroke', '#f0b429').attr('stroke-width', 2.5);
        htmx.ajax('GET', '/api/province/' + adcode, {target: '#side-panel', swap: 'innerHTML'});
        buildRankings();
        focusIndex = sortedProvinces.indexOf(adcode);
    }

    window.closePanel = function() {
        panel.classList.add('closed');
        backdrop.classList.remove('active');
        selectedAdcode = null;
        focusIndex = -1;
        d3.selectAll('.province-path').classed('selected', false)
            .attr('stroke', '#5a5a7e').attr('stroke-width', 1.2);
        buildRankings();
    };

    window._selectProvince = function(adcode) {
        if (activeView === 'table') {
            setView('split');
        }
        openPanel(adcode);
    };

    // Cluster annotations data
    const clusters = [
        { label: 'YANGTZE DELTA', lat: 30.5, lng: 120.5, provinces: ['310000', '320000', '330000'] },
        { label: 'PEARL RIVER DELTA', lat: 22.5, lng: 113.5, provinces: ['440000'] },
        { label: 'BEIJING-TIANJIN', lat: 40.5, lng: 117.5, provinces: ['110000', '120000'] },
        { label: 'WUHAN MEMORY', lat: 29.5, lng: 114.0, provinces: ['420000'] },
        { label: "XI'AN NAND", lat: 34.0, lng: 108.0, provinces: ['610000'] },
    ];

    // Province labels for tier 1/2 provinces
    const provinceLabels = {
        '310000': { short: 'SH',  lat: 31.2, lng: 121.5 },
        '110000': { short: 'BJ',  lat: 39.9, lng: 116.4 },
        '440000': { short: 'GD',  lat: 23.1, lng: 113.3 },
        '320000': { short: 'JS',  lat: 32.9, lng: 119.5 },
        '420000': { short: 'HB',  lat: 30.6, lng: 112.2 },
        '340000': { short: 'AH',  lat: 31.8, lng: 117.2 },
        '610000': { short: 'SN',  lat: 34.3, lng: 109.0 },
        '330000': { short: 'ZJ',  lat: 29.2, lng: 120.0 },
        '510000': { short: 'SC',  lat: 30.6, lng: 104.0 },
        '120000': { short: 'TJ',  lat: 39.1, lng: 117.2 },
        '350000': { short: 'FJ',  lat: 26.0, lng: 118.3 },
        '210000': { short: 'LN',  lat: 41.8, lng: 123.4 },
    };

    // Keyboard nav
    document.addEventListener('keydown', function(e) {
        // Escape closes panel
        if (e.key === 'Escape') {
            window.closePanel();
            return;
        }
        // Number keys 1-6 switch metrics
        if (e.key >= '1' && e.key <= '6' && !e.ctrlKey && !e.metaKey && !e.altKey) {
            const idx = parseInt(e.key) - 1;
            if (idx < metricKeys.length) {
                const tab = document.querySelector('[data-index="' + e.key + '"]');
                if (tab) tab.click();
            }
            return;
        }
        // Arrow keys cycle provinces
        if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
            e.preventDefault();
            if (!sortedProvinces.length) return;
            if (e.key === 'ArrowDown') {
                focusIndex = Math.min(focusIndex + 1, sortedProvinces.length - 1);
            } else {
                focusIndex = Math.max(focusIndex - 1, 0);
            }
            openPanel(sortedProvinces[focusIndex]);
            // Scroll row into view
            const row = document.querySelector('[data-adcode="' + sortedProvinces[focusIndex] + '"]');
            if (row) row.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        }
    });

    // Init
    function rewindGeometry(geometry) {
        if (!geometry) return geometry;
        if (geometry.type === 'Polygon') {
            return {
                type: 'Polygon',
                coordinates: geometry.coordinates.map(ring => ring.slice().reverse()),
            };
        }
        if (geometry.type === 'MultiPolygon') {
            return {
                type: 'MultiPolygon',
                coordinates: geometry.coordinates.map(poly =>
                    poly.map(ring => ring.slice().reverse())
                ),
            };
        }
        return geometry;
    }

    Promise.all([
        d3.json('/static/china-provinces-source.topo.json'),
        fetch('/api/provinces').then(r => r.json())
    ]).then(([topology, data]) => {
        provinceData = data;
        window.provinceData = data;
        buildMetricModel();
        renderMetricTabs();
        renderRankingsHeader();

        const container = document.getElementById('map-container');
        const width = container.clientWidth || 1200;
        const height = container.clientHeight || 700;

        svg.attr('width', width)
           .attr('height', height)
           .attr('viewBox', '0 0 ' + width + ' ' + height);

        const geojson = topojson.feature(topology, topology.objects.provinces);
        const provinceFeatures = geojson.features
            .filter(f => provinceData[String(f.properties.adcode)])
            .map(f => ({ ...f, geometry: rewindGeometry(f.geometry) }));

        // Filter to mainland provinces only for fitSize calculation
        const mainlandFeatures = provinceFeatures.filter(f => {
            const ac = String(f.properties.adcode);
            return ac !== '100000_JD' && ac !== '710000' && ac !== '810000' && ac !== '820000';
        });
        const mainlandGeo = { type: 'FeatureCollection', features: mainlandFeatures };

        // Auto-fit projection to container with padding
        const projection = d3.geoMercator()
            .fitExtent([[40, 20], [width - 120, height - 20]], mainlandGeo);

        const path = d3.geoPath().projection(projection);

        const g = svg.append('g');

        paths = g.selectAll('path')
            .data(provinceFeatures)
            .join('path')
            .attr('d', path)
            .attr('class', 'province-path')
            .on('mouseover', function(event, d) {
                const adcode = String(d.properties.adcode);
                const p = provinceData[adcode];
                if (!p) return;
                const rank = getRank(adcode);
                const max = getMaxValue(activeMetric);
                const val = metricValue(p, activeMetric);
                const pct = max > 0 ? (val / max * 100) : 0;

                document.getElementById('tt-name').textContent = p.name_en;
                document.getElementById('tt-cn').textContent = p.name_cn;
                document.getElementById('tt-value').textContent =
                    metricMeta[activeMetric].short + ': ' + fmtValue(adcode, activeMetric);
                document.getElementById('tt-rank').textContent =
                    rank ? '#' + rank + ' of ' + Object.keys(provinceData).length : '';
                document.getElementById('tt-bar').style.width = pct + '%';
                tooltip.classList.add('visible');

                // Highlight matching table row
                document.querySelectorAll('.rank-row').forEach(r => r.classList.remove('highlighted'));
                const row = document.querySelector('[data-adcode="' + adcode + '"]');
                if (row) row.classList.add('highlighted');
            })
            .on('mousemove', function(event) {
                const x = event.clientX + 16;
                const y = event.clientY - 20;
                tooltip.style.left = x + 'px';
                tooltip.style.top = y + 'px';
            })
            .on('mouseout', function(event, d) {
                tooltip.classList.remove('visible');
                // Restore table highlight state
                document.querySelectorAll('.rank-row').forEach(r => {
                    r.classList.toggle('highlighted', r.dataset.adcode === selectedAdcode);
                });
            })
            .on('click', function(event, d) {
                openPanel(String(d.properties.adcode));
            });

        // Province labels
        labelGroup = g.append('g').attr('class', 'province-labels');
        Object.entries(provinceLabels).forEach(([adcode, info]) => {
            const [x, y] = projection([info.lng, info.lat]);
            labelGroup.append('text')
                .attr('class', 'province-label')
                .attr('x', x)
                .attr('y', y)
                .text(info.short);
        });

        // Cluster annotations
        clusterGroup = g.append('g').attr('class', 'cluster-annotations');
        clusters.forEach(c => {
            const [x, y] = projection([c.lng, c.lat]);
            // Dashed ellipse around cluster
            clusterGroup.append('ellipse')
                .attr('cx', x)
                .attr('cy', y - 12)
                .attr('rx', 45)
                .attr('ry', 18)
                .attr('fill', 'none')
                .attr('stroke', '#8888aa')
                .attr('stroke-width', 0.5)
                .attr('stroke-dasharray', '3,3')
                .attr('opacity', 0.4);

            clusterGroup.append('text')
                .attr('class', 'cluster-label')
                .attr('x', x)
                .attr('y', y - 22)
                .text(c.label);
        });

        // South China Sea inset box
        const seaBoxX = width - 100;
        const seaBoxY = height - 90;
        const seaGroup = svg.append('g').attr('class', 'sea-inset');
        seaGroup.append('rect')
            .attr('x', seaBoxX)
            .attr('y', seaBoxY)
            .attr('width', 85)
            .attr('height', 75)
            .attr('fill', '#0f0f23')
            .attr('stroke', '#2a2a3e')
            .attr('stroke-width', 1)
            .attr('rx', 4);
        seaGroup.append('text')
            .attr('x', seaBoxX + 42)
            .attr('y', seaBoxY + 14)
            .attr('text-anchor', 'middle')
            .attr('fill', '#8888aa')
            .attr('font-size', '7px')
            .text('South China Sea');

        // Tiny Hainan representation
        const hainanFeature = provinceFeatures.find(f => String(f.properties.adcode) === '460000');
        if (hainanFeature) {
            const miniProj = d3.geoMercator()
                .center([110, 19])
                .scale(250)
                .translate([seaBoxX + 30, seaBoxY + 48]);
            const miniPath = d3.geoPath().projection(miniProj);
            seaGroup.append('path')
                .datum(hainanFeature)
                .attr('d', miniPath)
                .attr('fill', '#1a1a2e')
                .attr('stroke', '#2a2a3e')
                .attr('stroke-width', 0.5);
        }

        // Nine-dash line dots
        const dashPoints = [
            [112, 5], [114, 8], [116, 11], [117, 14], [116, 17], [113, 19], [110, 17]
        ];
        dashPoints.forEach(([lng, lat]) => {
            const [dx, dy] = d3.geoMercator()
                .center([110, 12])
                .scale(120)
                .translate([seaBoxX + 50, seaBoxY + 52])([lng, lat]);
            seaGroup.append('circle')
                .attr('cx', dx).attr('cy', dy).attr('r', 1)
                .attr('fill', '#3a3a5e');
        });

        recolor(false);
        buildRankings();
        updateStatCards();
        buildFabEntities();
        populateFabStatusFilter();
        buildFabEntityTable();
        buildTopStories();
        renderStory(0);
        startStoryRotation();

        // Fab entity controls
        fabSearchInput.addEventListener('input', buildFabEntityTable);
        fabStatusFilter.addEventListener('change', buildFabEntityTable);
        fabSortSelect.addEventListener('change', buildFabEntityTable);

        storyPrevBtn.addEventListener('click', () => {
            renderStory(activeStoryIndex - 1);
            startStoryRotation();
        });
        storyNextBtn.addEventListener('click', () => {
            renderStory(activeStoryIndex + 1);
            startStoryRotation();
        });
        storyOpenBtn.addEventListener('click', () => {
            if (!topStories.length) return;
            setView('split');
            openPanel(topStories[activeStoryIndex].adcode);
        });

        // Zoom (wheel is disabled to preserve normal page scroll behavior)
        const zoom = d3.zoom()
            .scaleExtent([1, 8])
            .on('zoom', (event) => g.attr('transform', event.transform));
        svg.call(zoom);
        svg.on('wheel.zoom', null);

        // Double-click to reset zoom
        svg.on('dblclick.zoom', null);
        svg.on('dblclick', () => {
            svg.transition().duration(500).call(zoom.transform, d3.zoomIdentity);
        });

        // Layout view switching
        document.querySelectorAll('.view-tab').forEach(tab => {
            tab.addEventListener('click', () => setView(tab.dataset.view));
        });
        setView('split');

    }).catch(err => {
        console.error('Map init failed:', err);
        document.getElementById('map-container').innerHTML =
            '<p style="color:red;padding:20px;">Map failed to load: ' + err.message + '</p>';
    });
})();
</script>
{% endblock %}
