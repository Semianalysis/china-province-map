{% extends "base.html" %}

{% block head %}
<style>
    /* --- Metric Tabs --- */
    .metric-tab {
        transition: all 0.2s ease;
        position: relative;
    }
    .metric-tab.active {
        background: #f0b429;
        color: #0f0f23;
        border-color: #f0b429;
        font-weight: 600;
    }
    .metric-tab:not(.active):hover {
        border-color: #f0b429;
        color: #f0b429;
    }

    /* --- Province Paths --- */
    .province-path {
        stroke: #5a5a7e;
        stroke-width: 1.2;
        cursor: pointer;
        transition: filter 0.15s ease;
    }
    .province-path:hover {
        stroke: #00D9FF;
        stroke-width: 2;
        filter: brightness(1.3);
    }
    .province-path.selected {
        stroke: #f0b429;
        stroke-width: 2.5;
    }

    /* --- Glow filter sizes --- */
    .province-path.glow-high { filter: drop-shadow(0 0 6px rgba(240,180,41,0.4)); }
    .province-path.glow-mid  { filter: drop-shadow(0 0 3px rgba(13,115,119,0.3)); }
    .province-path:hover { filter: brightness(1.3) drop-shadow(0 0 8px rgba(0,217,255,0.4)); }

    /* --- Tooltip --- */
    .map-tooltip {
        position: fixed;
        pointer-events: none;
        background: #1a1a2e;
        border: 1px solid #3a3a5e;
        border-radius: 8px;
        padding: 10px 14px;
        font-size: 13px;
        opacity: 0;
        transition: opacity 0.15s ease;
        z-index: 100;
        box-shadow: 0 4px 24px rgba(0,0,0,0.5), 0 0 12px rgba(0,217,255,0.1);
        min-width: 180px;
    }
    .map-tooltip.visible { opacity: 1; }

    /* --- Rankings Table --- */
    .rank-row {
        transition: background 0.12s ease;
    }
    .rank-row:hover {
        background: #1a1a2e;
    }
    .rank-row.highlighted {
        background: #16213e;
        border-left: 3px solid #00D9FF;
    }
    .rank-row.tier-gold td:first-child { color: #f0b429; font-weight: 700; }
    .rank-row.tier-silver td:first-child { color: #a0a0b8; font-weight: 600; }

    /* --- Stat Cards --- */
    .stat-card {
        background: #1a1a2e;
        border: 1px solid #2a2a3e;
        border-radius: 8px;
        padding: 12px 16px;
        min-width: 160px;
    }
    .stat-card .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        line-height: 1.2;
    }
    .stat-card .stat-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
    }

    /* --- Cluster annotations --- */
    .cluster-label {
        font-size: 10px;
        fill: #8888aa;
        font-weight: 500;
        pointer-events: none;
        text-anchor: middle;
        letter-spacing: 0.05em;
        paint-order: stroke;
        stroke: #0f0f23;
        stroke-width: 3px;
        stroke-linejoin: round;
    }

    /* --- Province labels --- */
    .province-label {
        font-size: 8px;
        fill: #c0c0d0;
        pointer-events: none;
        text-anchor: middle;
        dominant-baseline: central;
        paint-order: stroke;
        stroke: #0f0f23;
        stroke-width: 2.5px;
        stroke-linejoin: round;
    }

    /* --- Metric summary bar --- */
    .metric-summary {
        transition: opacity 0.3s ease;
    }

    /* --- Responsive --- */
    @media (max-width: 768px) {
        .stat-card { min-width: 120px; padding: 8px 12px; }
        .stat-card .stat-value { font-size: 1.1rem; }
        #rankings-section table { font-size: 12px; }
    }

    /* --- Mini bar in rankings --- */
    .mini-metric-bar {
        display: inline-block;
        height: 3px;
        border-radius: 2px;
        vertical-align: middle;
        opacity: 0.3;
        transition: opacity 0.15s;
    }
    .mini-metric-bar.active-metric {
        opacity: 1;
        height: 5px;
    }

    /* --- Layout view tabs --- */
    .view-tab {
        border: 1px solid #2a2a3e;
        color: #8888aa;
        background: transparent;
        transition: all 0.2s ease;
    }
    .view-tab:hover {
        border-color: #f0b429;
        color: #f0b429;
    }
    .view-tab.active {
        border-color: #f0b429;
        color: #0f0f23;
        background: #f0b429;
        font-weight: 600;
    }

    /* --- Lens tabs --- */
    .lens-tab {
        border: 1px solid #2a2a3e;
        color: #8888aa;
        background: transparent;
        transition: all 0.2s ease;
    }
    .lens-tab:hover {
        border-color: #f0b429;
        color: #f0b429;
    }
    .lens-tab.active {
        border-color: #f0b429;
        color: #0f0f23;
        background: #f0b429;
        font-weight: 600;
    }

    /* --- Fab entities table --- */
    .fab-row {
        transition: background 0.12s ease;
    }
    .fab-row:hover {
        background: #1a1a2e;
    }

    /* --- Story strip --- */
    .story-tag {
        border: 1px solid #2a2a3e;
        color: #00D9FF;
        background: #16213e;
    }
    .company-chip {
        border: 1px solid #2a2a3e;
        color: #00D9FF;
        background: #16213e;
    }
    .insight-tab {
        border: 1px solid #2a2a3e;
        background: #1a1a2e;
        color: #b7b7cc;
        transition: all 0.2s ease;
    }
    .insight-tab:hover {
        border-color: #f0b429;
        color: #ffffff;
    }
    .insight-tab .insight-sub {
        color: #8888aa;
    }
    .insight-tab:hover .insight-sub {
        color: #c7c7de;
    }

    /* --- Scatter plot --- */
    #scatter-tooltip {
        position: fixed;
        pointer-events: none;
        z-index: 140;
        background: #1a1a2e;
        border: 1px solid #3a3a5e;
        border-radius: 8px;
        padding: 8px 10px;
        font-size: 12px;
        opacity: 0;
        transition: opacity 0.15s ease;
        min-width: 180px;
    }
    #scatter-tooltip.visible { opacity: 1; }
    .scatter-dot {
        cursor: pointer;
        transition: r 0.12s ease, stroke-width 0.12s ease;
    }
    .scatter-dot:hover {
        stroke-width: 2.5;
    }

</style>
{% endblock %}

{% block content %}
<div class="relative" id="app-root">
    <div class="px-6 pt-4 pb-2 items-center gap-2 flex-wrap" id="insights-topbar" style="display:none;">
        <button id="stories-open" class="insight-tab rounded-lg px-3 py-2 text-left inline-flex items-center gap-3" title="Open strategic stories">
            <span class="text-sm font-semibold text-sa-gold">Stories</span>
            <span class="insight-sub text-xs">
                <span id="stories-count">0</span> items
            </span>
        </button>
        <button id="companies-open" class="insight-tab rounded-lg px-3 py-2 text-left inline-flex items-center gap-3" title="Open company profiles">
            <span class="text-sm font-semibold text-sa-cyan">Company Profiles</span>
            <span class="insight-sub text-xs">
                <span id="companies-count">0</span> profiles · <span id="companies-revenue">¥0B</span>
            </span>
        </button>
    </div>

    <div id="stories-modal" class="fixed inset-0 z-[120] hidden">
        <div id="stories-backdrop" class="absolute inset-0 bg-black/60"></div>
        <div class="absolute right-0 top-0 h-full w-full max-w-3xl bg-sa-card border-l border-sa-border overflow-y-auto">
            <div class="sticky top-0 z-10 bg-sa-card border-b border-sa-border px-5 py-4">
                <div class="flex items-center justify-between gap-3 mb-3">
                    <div>
                        <h3 class="text-white font-semibold text-base">Strategic Storyline</h3>
                        <p class="text-sa-muted text-xs" id="stories-modal-meta"></p>
                    </div>
                    <button id="stories-close" class="text-sa-muted hover:text-white text-lg leading-none p-1">&times;</button>
                </div>
                <input
                    id="stories-search"
                    type="text"
                    placeholder="Search stories, province, tags..."
                    class="w-full bg-sa-bg border border-sa-border rounded-md px-3 py-2 text-sm text-white placeholder-sa-muted outline-none focus:border-sa-cyan"
                />
                <div class="mt-3 flex flex-wrap items-center gap-2">
                    <div class="inline-flex items-center gap-1 rounded-full border border-sa-border bg-sa-bg/60 px-1 py-1" id="stories-mode-tabs">
                        <button class="view-tab active px-3 py-1 rounded-full text-xs" data-stories-mode="feed">Feed</button>
                        <button class="view-tab px-3 py-1 rounded-full text-xs" data-stories-mode="timeline">Timeline</button>
                    </div>
                    <select
                        id="stories-tag-filter"
                        class="bg-sa-bg border border-sa-border rounded-md px-2.5 py-1.5 text-xs text-white outline-none focus:border-sa-cyan"
                    >
                        <option value="">All Tags</option>
                    </select>
                </div>
            </div>
            <div class="p-5 space-y-3" id="stories-list"></div>
        </div>
    </div>

    <div id="companies-modal" class="fixed inset-0 z-[121] hidden">
        <div id="companies-backdrop" class="absolute inset-0 bg-black/60"></div>
        <div class="relative h-full w-full p-2 sm:p-4">
            <div class="mx-auto h-full w-full max-w-6xl overflow-y-auto rounded-lg border border-sa-border bg-sa-card shadow-2xl">
                <div class="sticky top-0 z-10 bg-sa-card border-b border-sa-border px-5 py-4">
                    <div class="flex items-center justify-between gap-3 mb-3">
                        <div>
                            <h3 class="text-white font-semibold text-base">Company Profiles</h3>
                            <p class="text-sa-muted text-xs" id="companies-modal-meta"></p>
                        </div>
                        <button id="companies-close" class="text-sa-muted hover:text-white text-lg leading-none p-1">&times;</button>
                    </div>
                    <div class="flex flex-wrap items-center gap-2">
                        <input
                            id="companies-search"
                            type="text"
                            placeholder="Search company, model, province..."
                            class="flex-1 min-w-[220px] bg-sa-bg border border-sa-border rounded-md px-3 py-2 text-sm text-white placeholder-sa-muted outline-none focus:border-sa-cyan"
                        />
                        <select
                            id="companies-type-filter"
                            class="bg-sa-bg border border-sa-border rounded-md px-2.5 py-2 text-xs text-white outline-none focus:border-sa-cyan"
                        >
                            <option value="">All Types</option>
                            <option value="semiconductor">Semiconductor</option>
                            <option value="ai">AI</option>
                        </select>
                    </div>
                </div>
                <div class="p-5 space-y-3" id="companies-list"></div>
            </div>
        </div>
    </div>

    <div id="province-modal" class="fixed inset-0 z-[130] hidden">
        <div id="province-backdrop" class="absolute inset-0 bg-black/70"></div>
        <div class="relative h-full w-full p-2 sm:p-4">
            <div
                id="province-modal-content"
                class="mx-auto h-full w-full max-w-[1280px] overflow-y-auto rounded-lg border border-sa-border bg-sa-card shadow-2xl"
            ></div>
        </div>
    </div>

    <!-- Storytelling Stat Cards -->
    <div class="px-6 pt-4 pb-2 flex flex-wrap gap-3" id="stat-cards">
        <div class="stat-card">
            <div class="stat-value text-sa-gold" id="sc-primary">--</div>
            <div class="stat-label text-sa-muted" id="sc-primary-label">Primary Metric Total</div>
        </div>
        <div class="stat-card">
            <div class="stat-value text-sa-cyan" id="sc-fab-provinces">--</div>
            <div class="stat-label text-sa-muted" id="sc-fab-provinces-label">Provinces with Active Fabs</div>
        </div>
        <div class="stat-card">
            <div class="stat-value text-white" id="sc-top-province">--</div>
            <div class="stat-label text-sa-muted" id="sc-top-province-label">Top Province (Score)</div>
        </div>
        <div class="stat-card">
            <div class="stat-value text-sa-coral" id="sc-secondary">--</div>
            <div class="stat-label text-sa-muted" id="sc-secondary-label">Secondary Indicator</div>
        </div>
    </div>

    <!-- Metric Tabs + Summary -->
    <div class="px-6 py-3 flex flex-wrap items-center gap-2" id="metric-tabs">
        <div class="inline-flex items-center gap-1.5 bg-sa-card/60 rounded-full px-1.5 py-1 border border-sa-border" id="lens-tabs">
            <button class="lens-tab active px-3 py-1 rounded-full text-xs" data-lens="industrial">Industrial Lens</button>
            <button class="lens-tab px-3 py-1 rounded-full text-xs" data-lens="funding">Funding Lens</button>
        </div>
        <div class="flex flex-wrap items-center gap-2" id="metric-tab-buttons"></div>
        <div class="ml-3 metric-summary text-sm" id="metric-summary">
            <span class="text-sa-muted">National avg:</span>
            <span class="text-white font-semibold" id="metric-avg">--</span>
            <span class="text-sa-muted mx-1">|</span>
            <span class="text-sa-muted">Max:</span>
            <span class="text-sa-gold font-semibold" id="metric-max">--</span>
        </div>
        <div class="ml-auto inline-flex items-center gap-1.5 bg-sa-card/60 rounded-full px-1.5 py-1 border border-sa-border" id="view-tabs">
            <button class="view-tab active px-3 py-1 rounded-full text-xs" data-view="split">Split</button>
            <button class="view-tab px-3 py-1 rounded-full text-xs" data-view="map">Map</button>
            <button class="view-tab px-3 py-1 rounded-full text-xs" data-view="table">Table</button>
            <button class="view-tab px-3 py-1 rounded-full text-xs" data-view="scatter">Scatter</button>
        </div>
    </div>

    <!-- Map Container -->
    <div class="relative" id="map-panel-wrap" style="height: calc(100vh - 200px); min-height: 500px; overflow: hidden;">
        <!-- Map -->
        <div id="map-container" style="position: relative; width: 100%; height: 100%; overflow: hidden;">
            <svg id="china-map" style="display: block;"></svg>

            <!-- Legend -->
            <div class="absolute bottom-4 left-6 flex items-center gap-2 bg-sa-card/80 backdrop-blur rounded-lg px-3 py-2 border border-sa-border">
                <span class="text-xs text-sa-muted" id="legend-label">Low</span>
                <div id="legend-bar" class="h-3 rounded" style="width: 140px;"></div>
                <span class="text-xs text-sa-muted" id="legend-max-label">High</span>
            </div>

            <!-- Tooltip -->
            <div class="map-tooltip" id="tooltip">
                <div class="flex items-center justify-between mb-1">
                    <span class="text-white font-semibold text-sm" id="tt-name"></span>
                    <span class="text-sa-muted text-xs" id="tt-cn"></span>
                </div>
                <div class="flex items-center justify-between mb-1.5">
                    <span class="text-sa-cyan text-sm font-medium" id="tt-value"></span>
                    <span class="text-sa-muted text-xs" id="tt-rank"></span>
                </div>
                <div class="w-full bg-sa-bg rounded-full h-1.5 mt-1">
                    <div class="rounded-full h-1.5 transition-all" id="tt-bar" style="width:0%; background: #00D9FF;"></div>
                </div>
            </div>
        </div>

    </div>

    <!-- Rankings Table -->
    <div class="px-6 py-6" id="scatter-section" style="display:none;">
        <h3 class="text-sm font-semibold text-sa-muted uppercase tracking-wider mb-3">
            Funding Vs Output — Province Efficiency Map
        </h3>
        <div class="bg-sa-card rounded-lg border border-sa-border overflow-hidden">
            <div id="scatter-container" class="relative" style="height: 560px;">
                <svg id="funding-scatter" style="display:block; width:100%; height:100%;"></svg>
                <div id="scatter-tooltip"></div>
            </div>
        </div>
    </div>

    <!-- Rankings Table -->
    <div class="px-6 py-6" id="rankings-section">
        <h3 class="text-sm font-semibold text-sa-muted uppercase tracking-wider mb-3">
            Province Rankings — <span id="ranking-metric-label">Overall Score</span>
        </h3>
        <div class="bg-sa-card rounded-lg border border-sa-border overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="sticky top-0 bg-sa-card z-10">
                        <tr id="rankings-header-row" class="border-b border-sa-border text-sa-muted text-xs uppercase tracking-wider"></tr>
                    </thead>
                    <tbody id="rankings-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Fab Entities Table -->
    <div class="px-6 pb-8" id="entities-section">
        <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
            <h3 class="text-sm font-semibold text-sa-muted uppercase tracking-wider">
                Fab Entity List
                <span class="normal-case text-xs text-sa-cyan ml-1" id="fab-entity-count"></span>
            </h3>
            <div class="flex flex-wrap items-center gap-2">
                <input
                    id="fab-search"
                    type="text"
                    placeholder="Search fab, province, node..."
                    class="bg-sa-card border border-sa-border rounded-md px-3 py-1.5 text-xs text-white placeholder-sa-muted outline-none focus:border-sa-cyan"
                />
                <select
                    id="fab-status-filter"
                    class="bg-sa-card border border-sa-border rounded-md px-2.5 py-1.5 text-xs text-white outline-none focus:border-sa-cyan"
                >
                    <option value="">All Statuses</option>
                </select>
                <select
                    id="fab-sort"
                    class="bg-sa-card border border-sa-border rounded-md px-2.5 py-1.5 text-xs text-white outline-none focus:border-sa-cyan"
                >
                    <option value="capacity_desc">Capacity ↓</option>
                    <option value="capacity_asc">Capacity ↑</option>
                    <option value="name_asc">Name A-Z</option>
                    <option value="province_asc">Province A-Z</option>
                    <option value="status_asc">Status</option>
                </select>
            </div>
        </div>
        <div class="bg-sa-card rounded-lg border border-sa-border overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="sticky top-0 bg-sa-card z-10">
                        <tr class="border-b border-sa-border text-sa-muted text-xs uppercase tracking-wider">
                            <th class="px-4 py-2.5 text-left w-12">#</th>
                            <th class="px-4 py-2.5 text-left">Fab</th>
                            <th class="px-4 py-2.5 text-left">Province</th>
                            <th class="px-4 py-2.5 text-left">Node</th>
                            <th class="px-4 py-2.5 text-center">Status</th>
                            <th class="px-4 py-2.5 text-right">Capacity (KWPM)</th>
                            <th class="px-4 py-2.5 text-left">Sector</th>
                        </tr>
                    </thead>
                    <tbody id="fab-entities-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    let provinceData = {};
    let activeMetric = 'composite_score';
    let metricKeys = [];
    let metricMeta = {};
    let industrialMetricKeys = [];
    let industrialMetricMeta = {};
    let fundingMetricKeys = [];
    let fundingMetricMeta = {};
    let activeLens = 'industrial';
    let selectedAdcode = null;
    let paths, labelGroup, clusterGroup;
    let colorScale;
    let sortedProvinces = []; // for keyboard nav
    let fabEntities = [];
    let topStories = [];
    let companyProfiles = [];
    let storiesMode = 'feed';
    let focusIndex = -1;
    let activeView = 'split';

    const svg = d3.select('#china-map');
    const tooltip = document.getElementById('tooltip');
    const provinceModal = document.getElementById('province-modal');
    const provinceBackdrop = document.getElementById('province-backdrop');
    const provinceModalContent = document.getElementById('province-modal-content');
    const mapPanelWrap = document.getElementById('map-panel-wrap');
    const scatterSection = document.getElementById('scatter-section');
    const scatterSvg = d3.select('#funding-scatter');
    const scatterTooltip = document.getElementById('scatter-tooltip');
    const rankingsSection = document.getElementById('rankings-section');
    const entitiesSection = document.getElementById('entities-section');
    const fabSearchInput = document.getElementById('fab-search');
    const fabStatusFilter = document.getElementById('fab-status-filter');
    const fabSortSelect = document.getElementById('fab-sort');
    const insightsTopbar = document.getElementById('insights-topbar');
    const storiesOpenBtn = document.getElementById('stories-open');
    const storiesModal = document.getElementById('stories-modal');
    const storiesBackdrop = document.getElementById('stories-backdrop');
    const storiesCloseBtn = document.getElementById('stories-close');
    const storiesSearch = document.getElementById('stories-search');
    const storiesTagFilter = document.getElementById('stories-tag-filter');
    const storiesCount = document.getElementById('stories-count');
    const storiesModalMeta = document.getElementById('stories-modal-meta');
    const storiesList = document.getElementById('stories-list');
    const companiesOpenBtn = document.getElementById('companies-open');
    const companiesCount = document.getElementById('companies-count');
    const companiesRevenue = document.getElementById('companies-revenue');
    const companiesModal = document.getElementById('companies-modal');
    const companiesBackdrop = document.getElementById('companies-backdrop');
    const companiesCloseBtn = document.getElementById('companies-close');
    const companiesSearch = document.getElementById('companies-search');
    const companiesTypeFilter = document.getElementById('companies-type-filter');
    const companiesModalMeta = document.getElementById('companies-modal-meta');
    const companiesList = document.getElementById('companies-list');

    function syncBodyScrollLock() {
        const hasStoriesOpen = !storiesModal.classList.contains('hidden');
        const hasProvinceOpen = !provinceModal.classList.contains('hidden');
        const hasCompaniesOpen = !companiesModal.classList.contains('hidden');
        document.body.style.overflow = (hasStoriesOpen || hasProvinceOpen || hasCompaniesOpen) ? 'hidden' : '';
    }

    function syncInsightsTopbar() {
        const hasStories = topStories.length > 0;
        const hasCompanies = companyProfiles.length > 0;

        if (storiesOpenBtn) storiesOpenBtn.style.display = hasStories ? 'inline-flex' : 'none';
        if (companiesOpenBtn) companiesOpenBtn.style.display = hasCompanies ? 'inline-flex' : 'none';
        if (insightsTopbar) insightsTopbar.style.display = (hasStories || hasCompanies) ? 'flex' : 'none';
    }

    function setView(view) {
        activeView = view;
        document.querySelectorAll('#view-tabs .view-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.view === view);
        });

        if (view === 'map') {
            mapPanelWrap.style.display = 'block';
            scatterSection.style.display = 'none';
            rankingsSection.style.display = 'none';
            entitiesSection.style.display = 'none';
            return;
        }
        if (view === 'table') {
            mapPanelWrap.style.display = 'none';
            scatterSection.style.display = 'none';
            rankingsSection.style.display = 'block';
            entitiesSection.style.display = 'block';
            window.closePanel();
            return;
        }
        if (view === 'scatter') {
            mapPanelWrap.style.display = 'none';
            scatterSection.style.display = 'block';
            rankingsSection.style.display = 'none';
            entitiesSection.style.display = 'none';
            window.closePanel();
            buildFundingScatter();
            return;
        }

        mapPanelWrap.style.display = 'block';
        scatterSection.style.display = 'none';
        rankingsSection.style.display = 'block';
        entitiesSection.style.display = 'none';
    }

    const knownMetricOrderSets = [
        ['composite_score', 'fab_capacity', 'ai_compute_power', 'gov_subsidies', 'stem_graduates', 'tech_gdp_share'],
        ['composite_score', 'ic_revenue', 'computing_power', 'gov_investment', 'rd_intensity', 'power_price'],
    ];

    const shortLabelMap = {
        composite_score: 'Score',
        fab_capacity: 'Fabs',
        ai_compute_power: 'AI',
        gov_subsidies: 'Gov',
        stem_graduates: 'STEM',
        tech_gdp_share: 'GDP%',
        ic_revenue: 'IC Rev',
        computing_power: 'Compute',
        gov_investment: 'Gov Inv',
        rd_intensity: 'R&D',
        power_price: 'Power',
        funding_semi_b_cny: 'Semi',
        funding_ai_b_cny: 'AI',
        funding_total_b_cny: 'Total',
    };

    const fundingMetricConfig = {
        funding_semi_b_cny: {
            field: 'semiconductor_total_b_cny',
            label: 'Semi Funding (B CNY)',
            short: 'Semi Funding',
            unit: 'B_CNY',
        },
        funding_ai_b_cny: {
            field: 'ai_compute_total_b_cny',
            label: 'AI Funding (B CNY)',
            short: 'AI Funding',
            unit: 'B_CNY',
        },
        funding_total_b_cny: {
            field: 'grand_total_b_cny',
            label: 'Total Funding (B CNY)',
            short: 'Total Funding',
            unit: 'B_CNY',
        },
    };

    function defaultLabelFromKey(key) {
        return key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    }

    function makeValueFormatter(unit) {
        if (unit === 'pct') return v => v + '%';
        if (unit === 'B_CNY') return v => '\u00a5' + (Math.round((Number(v) || 0) * 10) / 10).toLocaleString() + 'B';
        if (unit === 'kwpm') return v => v + 'K';
        if (unit === 'annual') return v => Math.round(v).toLocaleString();
        if (unit === 'MW') return v => v + ' MW';
        if (unit === 'CNY/kWh') return v => '\u00a5' + v + '/kWh';
        return v => (Number.isFinite(Number(v)) ? Number(v).toLocaleString() : String(v));
    }

    function buildMetricModels() {
        const provinces = Object.values(provinceData);
        const firstProvince = provinces.find(p => p && p.metrics && typeof p.metrics === 'object');
        if (!firstProvince) {
            industrialMetricKeys = ['composite_score'];
            industrialMetricMeta = {
                composite_score: { key: 'composite_score', label: 'Overall Score', short: 'Score', unit: 'index', format: v => v.toString() },
            };
        } else {
            const available = Object.keys(firstProvince.metrics).filter(k =>
                provinces.some(p => p?.metrics?.[k] && Number.isFinite(Number(p.metrics[k].value)))
            );

            let ordered = knownMetricOrderSets.find(set => set.every(k => available.includes(k))) || [];
            if (!ordered.length) {
                ordered = available.slice();
                if (ordered.includes('composite_score')) {
                    ordered = ['composite_score', ...ordered.filter(k => k !== 'composite_score')];
                }
            }
            if (!ordered.length) ordered = Object.keys(firstProvince.metrics);

            industrialMetricKeys = ordered.slice(0, 6);
            industrialMetricMeta = {};
            industrialMetricKeys.forEach(k => {
                const sample = provinces.find(p => p?.metrics?.[k])?.metrics?.[k] || {};
                const label = sample.label || defaultLabelFromKey(k);
                const short = shortLabelMap[k] || label.split(' ')[0] || label;
                const unit = sample.unit || '';
                industrialMetricMeta[k] = { key: k, label, short, unit, format: makeValueFormatter(unit), source: 'metrics' };
            });
        }

        fundingMetricKeys = Object.keys(fundingMetricConfig).filter(metric =>
            provinces.some(p => Number.isFinite(Number(p?.funding_summary?.[fundingMetricConfig[metric].field])))
        );
        fundingMetricMeta = {};
        fundingMetricKeys.forEach(metric => {
            const cfg = fundingMetricConfig[metric];
            fundingMetricMeta[metric] = {
                key: metric,
                label: cfg.label,
                short: cfg.short,
                unit: cfg.unit,
                format: makeValueFormatter(cfg.unit),
                source: 'funding',
            };
        });
    }

    function setLens(lens, explicitMetric) {
        activeLens = lens === 'funding' ? 'funding' : 'industrial';
        if (activeLens === 'funding' && fundingMetricKeys.length) {
            metricKeys = fundingMetricKeys.slice();
            metricMeta = { ...fundingMetricMeta };
        } else {
            metricKeys = industrialMetricKeys.slice();
            metricMeta = { ...industrialMetricMeta };
            activeLens = 'industrial';
        }

        const defaultMetric = activeLens === 'funding'
            ? (metricKeys.includes('funding_total_b_cny') ? 'funding_total_b_cny' : metricKeys[0])
            : (metricKeys.includes('composite_score') ? 'composite_score' : metricKeys[0]);
        activeMetric = (explicitMetric && metricKeys.includes(explicitMetric)) ? explicitMetric : defaultMetric;

        document.querySelectorAll('.lens-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.lens === activeLens);
        });

        renderMetricTabs();
        renderRankingsHeader();
        recolor(true);
        buildRankings();
        updateStatCards();
        if (activeView === 'scatter') {
            buildFundingScatter();
        }
    }

    function renderMetricTabs() {
        const container = document.getElementById('metric-tab-buttons');
        container.innerHTML = metricKeys.map((k, i) => {
            const activeClass = k === activeMetric ? 'active' : 'text-sa-muted';
            return '<button class="metric-tab ' + activeClass + ' px-4 py-1.5 rounded-full text-sm border border-sa-border" ' +
                'data-metric="' + k + '" data-index="' + (i + 1) + '">' + escapeHtml(metricMeta[k].label) + '</button>';
        }).join('');

        document.querySelectorAll('.metric-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.metric-tab').forEach(t => {
                    t.classList.remove('active');
                    t.classList.add('text-sa-muted');
                });
                tab.classList.add('active');
                tab.classList.remove('text-sa-muted');
                activeMetric = tab.dataset.metric;
                recolor(true);
                buildRankings();
                updateStatCards();
            });
        });
    }

    function renderRankingsHeader() {
        const row = document.getElementById('rankings-header-row');
        const metricHeaders = metricKeys.map(k =>
            '<th class="px-4 py-2.5 text-center" title="' + escapeHtml(metricMeta[k].label) + '">' +
            escapeHtml(metricMeta[k].short) + '</th>'
        ).join('');
        row.innerHTML =
            '<th class="px-4 py-2.5 text-left w-12">#</th>' +
            '<th class="px-4 py-2.5 text-left">Province</th>' +
            '<th class="px-4 py-2.5 text-left">Region</th>' +
            metricHeaders +
            '<th class="px-4 py-2.5 text-right w-40">Active Metric</th>';
    }

    // Custom SA color scale: visible navy -> teal -> gold -> coral
    // Floor color (#1a2e4a) must be visually distinct from page background (#0f0f23)
    const saColorInterpolator = (function() {
        const colors = ['#1a2e4a', '#0d5f6a', '#0d7377', '#3a9a5c', '#a8b840', '#f0b429', '#ff6b35'];
        const scale = d3.scaleLinear()
            .domain(colors.map((_, i) => i / (colors.length - 1)))
            .range(colors)
            .interpolate(d3.interpolateRgb);
        return t => scale(Math.max(0, Math.min(1, t)));
    })();

    function metricValue(province, metric) {
        if (fundingMetricConfig[metric]) {
            const field = fundingMetricConfig[metric].field;
            return Number(province?.funding_summary?.[field]) || 0;
        }
        return Number(province?.metrics?.[metric]?.value) || 0;
    }

    function makeColorScale(metric) {
        const values = Object.values(provinceData).map(p => metricValue(p, metric));
        const max = Math.max(...values) || 1;
        return v => saColorInterpolator(v / max);
    }

    function fmtValue(adcode, metric) {
        const p = provinceData[adcode];
        if (!p || !metricMeta[metric]) return '';
        return metricMeta[metric].format(metricValue(p, metric));
    }

    function getMaxValue(metric) {
        return Math.max(...Object.values(provinceData).map(p => metricValue(p, metric))) || 1;
    }

    // Compute rank for a province on active metric
    function getRank(adcode) {
        const sorted = Object.entries(provinceData)
            .sort((a, b) => metricValue(b[1], activeMetric) - metricValue(a[1], activeMetric));
        const idx = sorted.findIndex(([ac]) => ac === adcode);
        return idx >= 0 ? idx + 1 : null;
    }

    function escapeHtml(value) {
        return String(value ?? '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function getStatusBadgeClass(status) {
        if (status === 'Operating') return 'bg-green-900/40 text-green-400 border border-green-500/30';
        if (status === 'Under Construction') return 'bg-yellow-900/40 text-yellow-400 border border-yellow-500/30';
        if (status === 'Ramping') return 'bg-blue-900/40 text-blue-400 border border-blue-500/30';
        if (status === 'Pilot') return 'bg-purple-900/40 text-purple-400 border border-purple-500/30';
        if (status === 'Suspended') return 'bg-red-900/40 text-red-400 border border-red-500/30';
        return 'bg-sa-navy text-sa-cyan border border-sa-cyan/30';
    }

    function statusSortRank(status) {
        const order = {
            Operating: 1,
            Ramping: 2,
            Pilot: 3,
            'Under Construction': 4,
            Suspended: 5,
        };
        return order[status] || 99;
    }

    function buildFabEntities() {
        fabEntities = Object.entries(provinceData).flatMap(([adcode, province]) =>
            (province.fabs || []).map((fab, index) => ({
                id: adcode + '_' + index,
                adcode,
                province_en: province.name_en,
                province_cn: province.name_cn,
                region: province.region,
                name: fab.name || 'Unknown Fab',
                node: fab.node || 'N/A',
                capacity_kwpm: Number(fab.capacity_kwpm) || 0,
                status: fab.status || 'Unknown',
                sector: fab.sector || 'N/A',
            }))
        );
    }

    function buildTopStories() {
        function extractStoryYear(story) {
            const text = [story?.headline || '', story?.body || ''].join(' ');
            const matches = text.match(/(?:19|20)\d{2}/g) || [];
            if (!matches.length) return null;
            return Math.max(...matches.map(v => Number(v)));
        }

        topStories = Object.entries(provinceData).flatMap(([adcode, province]) =>
            (province.top_stories || []).map((story, idx) => ({
                id: adcode + '_' + idx,
                adcode,
                headline: story.headline || 'Untitled Story',
                body: story.body || '',
                tags: Array.isArray(story.tags) ? story.tags : [],
                province_en: province.name_en || adcode,
                province_cn: province.name_cn || '',
                story_order: idx,
                score: metricValue(province, 'composite_score'),
                year: extractStoryYear(story),
            }))
        );
        topStories.sort((a, b) => (b.score - a.score) || (a.story_order - b.story_order));

        const uniqueTags = Array.from(new Set(topStories.flatMap(s => s.tags || []))).sort();
        storiesTagFilter.innerHTML =
            '<option value="">All Tags</option>' +
            uniqueTags.map(tag => '<option value="' + escapeHtml(tag) + '">' + escapeHtml(tag) + '</option>').join('');
    }

    function renderStoriesHeading() {
        storiesCount.textContent = topStories.length.toLocaleString();
        storiesModalMeta.textContent = topStories.length + ' stories from ' + Object.keys(provinceData).length + ' provinces';
        syncInsightsTopbar();
    }

    function renderStoriesList() {
        const q = (storiesSearch.value || '').trim().toLowerCase();
        const activeTag = storiesTagFilter.value || '';
        const filtered = topStories.filter(story => {
            if (activeTag && !(story.tags || []).includes(activeTag)) return false;
            if (!q) return true;
            const haystack = [
                story.headline,
                story.body,
                story.province_en,
                story.province_cn,
                ...(story.tags || []),
            ].join(' ').toLowerCase();
            return haystack.includes(q);
        });

        const ordered = filtered.slice().sort((a, b) => {
            if (storiesMode === 'timeline') {
                const ay = Number.isFinite(a.year) ? a.year : -Infinity;
                const by = Number.isFinite(b.year) ? b.year : -Infinity;
                return by - ay || (b.score - a.score) || (a.story_order - b.story_order);
            }
            return (b.score - a.score) || (a.story_order - b.story_order);
        });

        storiesList.innerHTML = ordered.map((story, i) =>
            '<article class="bg-sa-navy/30 rounded-lg border border-sa-border p-3">' +
                '<div class="flex items-start justify-between gap-3">' +
                    '<div>' +
                        '<div class="text-[11px] uppercase tracking-wider text-sa-muted mb-1">' +
                            (storiesMode === 'timeline'
                                ? ('Year ' + (story.year || 'Undated'))
                                : ('Story ' + (i + 1))) +
                        '</div>' +
                        '<h4 class="text-white font-semibold text-sm">' + escapeHtml(story.headline) + '</h4>' +
                        '<p class="text-sa-cyan text-xs mt-1">' + escapeHtml(story.province_en) +
                            (story.province_cn ? ' · ' + escapeHtml(story.province_cn) : '') + '</p>' +
                    '</div>' +
                    '<button class="story-open-item text-xs px-2 py-1 rounded border border-sa-gold text-sa-gold hover:bg-sa-gold hover:text-sa-bg" data-adcode="' + story.adcode + '">' +
                        'Open Province' +
                    '</button>' +
                '</div>' +
                '<p class="text-sa-muted text-xs mt-2 leading-relaxed">' + escapeHtml(story.body) + '</p>' +
                '<div class="mt-2 flex flex-wrap gap-1.5">' +
                    (story.tags || []).map(tag =>
                        '<span class="story-tag text-[11px] px-2 py-0.5 rounded-full">' + escapeHtml(tag) + '</span>'
                    ).join('') +
                '</div>' +
            '</article>'
        ).join('');

        if (!filtered.length) {
            storiesList.innerHTML = '<p class="text-sm text-sa-muted">No stories match your search.</p>';
        }

        storiesModalMeta.textContent = ordered.length + ' of ' + topStories.length + ' stories';
    }

    function openStoriesModal() {
        if (!topStories.length) return;
        storiesModal.classList.remove('hidden');
        syncBodyScrollLock();
        storiesSearch.value = '';
        storiesTagFilter.value = '';
        renderStoriesList();
    }

    function closeStoriesModal() {
        storiesModal.classList.add('hidden');
        syncBodyScrollLock();
    }

    function normalizeProvinceName(value) {
        return String(value || '')
            .toLowerCase()
            .replace(/\b(province|municipality|autonomous region|special administrative region)\b/g, '')
            .replace(/\s+/g, ' ')
            .trim();
    }

    function buildCompanyProfiles(payload) {
        const semi = Array.isArray(payload?.semi_companies) ? payload.semi_companies : [];
        const ai = Array.isArray(payload?.ai_companies) ? payload.ai_companies : [];

        companyProfiles = [
            ...semi.map((c, idx) => ({
                id: 'semi_' + idx,
                type: 'semiconductor',
                ...c,
            })),
            ...ai.map((c, idx) => ({
                id: 'ai_' + idx,
                type: 'ai',
                ...c,
            })),
        ];
    }

    function renderCompanyHeading() {
        const totalRevenue = companyProfiles.reduce((sum, c) => sum + (Number(c.revenue_b_cny) || 0), 0);
        companiesCount.textContent = companyProfiles.length.toLocaleString();
        companiesRevenue.textContent = '\u00a5' + Math.round(totalRevenue).toLocaleString() + 'B';

        const semiCount = companyProfiles.filter(c => c.type === 'semiconductor').length;
        const aiCount = companyProfiles.filter(c => c.type === 'ai').length;
        companiesModalMeta.textContent = semiCount + ' semiconductor + ' + aiCount + ' AI profiles';
        syncInsightsTopbar();
    }

    function findProvinceAdcodeByName(provinceName) {
        const target = normalizeProvinceName(provinceName);
        if (!target) return null;
        const found = Object.entries(provinceData).find(([, p]) =>
            normalizeProvinceName(p.name_en) === target || normalizeProvinceName(p.name_cn) === target
        );
        return found ? found[0] : null;
    }

    function renderCompanyList() {
        const q = (companiesSearch.value || '').trim().toLowerCase();
        const typeFilter = companiesTypeFilter.value || '';
        const rows = companyProfiles
            .filter(c => !typeFilter || c.type === typeFilter)
            .filter(c => {
                if (!q) return true;
                const haystack = [
                    c.name,
                    c.name_cn,
                    c.hq_city,
                    c.hq_province,
                    c.sub_type,
                    c.key_products,
                    c.flagship_model,
                    c.profile,
                    c.ticker,
                ].join(' ').toLowerCase();
                return haystack.includes(q);
            })
            .sort((a, b) => (Number(b.valuation_b_cny) || 0) - (Number(a.valuation_b_cny) || 0));

        companiesList.innerHTML = rows.map((c, i) => {
            const adcode = findProvinceAdcodeByName(c.hq_province);
            const revenue = Number(c.revenue_b_cny) || 0;
            const valuation = Number(c.valuation_b_cny) || 0;
            const facts = Array.isArray(c.key_facts) ? c.key_facts.slice(0, 2) : [];
            const typeLabel = c.type === 'semiconductor' ? 'Semiconductor' : 'AI';
            const typeClass = c.type === 'semiconductor'
                ? 'text-sa-gold border-sa-gold/40 bg-yellow-900/20'
                : 'text-sa-cyan border-sa-cyan/40 bg-cyan-900/20';
            return '<article class="bg-sa-navy/30 rounded-lg border border-sa-border p-3">' +
                '<div class="flex items-start justify-between gap-3">' +
                    '<div>' +
                        '<div class="text-[11px] uppercase tracking-wider text-sa-muted mb-1">Profile ' + (i + 1) + '</div>' +
                        '<h4 class="text-white font-semibold text-sm">' + escapeHtml(c.name || 'Unknown') +
                            (c.name_cn ? ' <span class="text-sa-muted text-xs font-normal">' + escapeHtml(c.name_cn) + '</span>' : '') +
                        '</h4>' +
                        '<div class="mt-1 flex flex-wrap items-center gap-1.5">' +
                            '<span class="company-chip text-[11px] px-2 py-0.5 rounded-full border ' + typeClass + '">' + typeLabel + '</span>' +
                            (c.sub_type ? '<span class="company-chip text-[11px] px-2 py-0.5 rounded-full">' + escapeHtml(c.sub_type) + '</span>' : '') +
                            (c.hq_province ? '<span class="company-chip text-[11px] px-2 py-0.5 rounded-full">' + escapeHtml(c.hq_province) + '</span>' : '') +
                        '</div>' +
                    '</div>' +
                    (adcode
                        ? '<button class="company-open-item text-xs px-2 py-1 rounded border border-sa-gold text-sa-gold hover:bg-sa-gold hover:text-sa-bg" data-adcode="' + adcode + '">Open Province</button>'
                        : '') +
                '</div>' +
                '<div class="mt-2 grid grid-cols-2 md:grid-cols-5 gap-2 text-xs">' +
                    '<div class="text-sa-muted">Founded<br><span class="text-white">' + escapeHtml(c.founded || 'N/A') + '</span></div>' +
                    '<div class="text-sa-muted">Revenue<br><span class="text-sa-cyan">' + (revenue ? ('\u00a5' + Math.round(revenue).toLocaleString() + 'B') : 'N/A') + '</span></div>' +
                    '<div class="text-sa-muted">Valuation<br><span class="text-sa-cyan">' + (valuation ? ('\u00a5' + Math.round(valuation).toLocaleString() + 'B') : 'N/A') + '</span></div>' +
                    '<div class="text-sa-muted">Employees<br><span class="text-white">' + ((Number(c.employees) || 0) ? Number(c.employees).toLocaleString() : 'N/A') + '</span></div>' +
                    '<div class="text-sa-muted">Ticker<br><span class="text-white">' + escapeHtml(c.ticker || (c.public ? 'Public' : 'Private')) + '</span></div>' +
                '</div>' +
                ((c.flagship_model || c.key_products)
                    ? '<p class="text-sa-muted text-xs mt-2 leading-relaxed">' +
                        (c.flagship_model ? ('<span class="text-sa-cyan">Flagship:</span> ' + escapeHtml(c.flagship_model) + '. ') : '') +
                        (c.key_products ? escapeHtml(c.key_products) : '') +
                      '</p>'
                    : '') +
                (facts.length
                    ? '<ul class="mt-2 space-y-1">' +
                        facts.map(f => '<li class="text-sa-muted text-xs leading-relaxed">- ' + escapeHtml(f) + '</li>').join('') +
                      '</ul>'
                    : '') +
            '</article>';
        }).join('');

        if (!rows.length) {
            companiesList.innerHTML = '<p class="text-sm text-sa-muted">No company profiles match your search.</p>';
        }

        companiesModalMeta.textContent = rows.length + ' of ' + companyProfiles.length + ' profiles';
    }

    function openCompaniesModal() {
        if (!companyProfiles.length) return;
        companiesModal.classList.remove('hidden');
        companiesSearch.value = '';
        companiesTypeFilter.value = '';
        syncBodyScrollLock();
        renderCompanyList();
    }

    function closeCompaniesModal() {
        companiesModal.classList.add('hidden');
        syncBodyScrollLock();
    }

    function populateFabStatusFilter() {
        const statuses = Array.from(new Set(fabEntities.map(f => f.status))).sort();
        fabStatusFilter.innerHTML = '<option value="">All Statuses</option>' +
            statuses.map(s => '<option value="' + escapeHtml(s) + '">' + escapeHtml(s) + '</option>').join('');
    }

    function buildFabEntityTable() {
        const query = (fabSearchInput.value || '').trim().toLowerCase();
        const status = fabStatusFilter.value || '';
        const sortBy = fabSortSelect.value || 'capacity_desc';

        let rows = fabEntities.filter(f => {
            const matchesStatus = !status || f.status === status;
            if (!matchesStatus) return false;
            if (!query) return true;
            const haystack = [
                f.name,
                f.province_en,
                f.province_cn,
                f.region,
                f.node,
                f.status,
                f.sector,
            ].join(' ').toLowerCase();
            return haystack.includes(query);
        });

        rows = rows.slice().sort((a, b) => {
            if (sortBy === 'capacity_asc') return a.capacity_kwpm - b.capacity_kwpm;
            if (sortBy === 'name_asc') return a.name.localeCompare(b.name);
            if (sortBy === 'province_asc') return a.province_en.localeCompare(b.province_en);
            if (sortBy === 'status_asc') {
                const byStatus = statusSortRank(a.status) - statusSortRank(b.status);
                return byStatus || (b.capacity_kwpm - a.capacity_kwpm);
            }
            return b.capacity_kwpm - a.capacity_kwpm;
        });

        document.getElementById('fab-entity-count').textContent =
            rows.length + ' / ' + fabEntities.length + ' shown';

        const tbody = document.getElementById('fab-entities-body');
        tbody.innerHTML = rows.map((f, i) =>
            '<tr class="fab-row border-b border-sa-border/30 cursor-pointer" ' +
                'data-adcode="' + f.adcode + '" ' +
                'onmouseenter="window._highlightProvince(\'' + f.adcode + '\')" ' +
                'onmouseleave="window._unhighlightProvince(\'' + f.adcode + '\')" ' +
                'onclick="window._selectProvince(\'' + f.adcode + '\')">' +
                '<td class="px-4 py-2 text-sa-muted">' + (i + 1) + '</td>' +
                '<td class="px-4 py-2 text-white font-medium">' + escapeHtml(f.name) + '</td>' +
                '<td class="px-4 py-2 text-sa-muted text-xs">' +
                    escapeHtml(f.province_en) + ' <span class="opacity-70">' + escapeHtml(f.province_cn) + '</span></td>' +
                '<td class="px-4 py-2 text-sa-muted text-xs">' + escapeHtml(f.node) + '</td>' +
                '<td class="px-4 py-2 text-center">' +
                    '<span class="text-xs px-2 py-0.5 rounded-full ' + getStatusBadgeClass(f.status) + '">' +
                    escapeHtml(f.status) + '</span></td>' +
                '<td class="px-4 py-2 text-right text-sa-cyan font-medium">' + f.capacity_kwpm.toLocaleString() + '</td>' +
                '<td class="px-4 py-2 text-sa-muted text-xs">' + escapeHtml(f.sector) + '</td>' +
            '</tr>'
        ).join('');
    }

    // Update stat cards
    function updateStatCards() {
        const provinces = Object.values(provinceData);
        if (!provinces.length) return;

        const primaryEl = document.getElementById('sc-primary');
        const secondaryEl = document.getElementById('sc-secondary');
        const middleLabelEl = document.getElementById('sc-fab-provinces-label');
        const primaryLabelEl = document.getElementById('sc-primary-label');
        const topProvinceLabelEl = document.getElementById('sc-top-province-label');
        const secondaryLabelEl = document.getElementById('sc-secondary-label');

        if (activeLens === 'funding') {
            const totalFunding = provinces.reduce((s, p) => s + metricValue(p, 'funding_total_b_cny'), 0);
            const totalSemiFunding = provinces.reduce((s, p) => s + metricValue(p, 'funding_semi_b_cny'), 0);
            const totalAiFunding = provinces.reduce((s, p) => s + metricValue(p, 'funding_ai_b_cny'), 0);
            const totalDeals = provinces.reduce((s, p) => s + (Number(p?.funding_summary?.deal_count) || 0), 0);

            primaryEl.textContent = '\u00a5' + Math.round(totalFunding).toLocaleString() + 'B';
            primaryLabelEl.textContent = 'Total Funding (B CNY)';
            document.getElementById('sc-fab-provinces').textContent = '\u00a5' + Math.round(totalSemiFunding).toLocaleString() + 'B';
            middleLabelEl.textContent = 'Semi Funding (B CNY)';
            secondaryEl.textContent = '\u00a5' + Math.round(totalAiFunding).toLocaleString() + 'B';
            secondaryLabelEl.textContent = 'AI Funding (B CNY)';

            const top = Object.entries(provinceData)
                .sort((a, b) => metricValue(b[1], 'funding_total_b_cny') - metricValue(a[1], 'funding_total_b_cny'))[0];
            if (top) {
                document.getElementById('sc-top-province').textContent =
                    top[1].name_en + ' (' + metricMeta.funding_total_b_cny.format(metricValue(top[1], 'funding_total_b_cny')) + ')';
                topProvinceLabelEl.textContent = 'Top Province (Funding)';
            }

            // Reuse secondary card label for additional context when hovering in UI.
            secondaryEl.setAttribute('title', totalDeals.toLocaleString() + ' total funding deals');
            return;
        }

        // Industrial lens stat cards
        const fabProvinces = provinces.filter(p => p.fabs && p.fabs.some(f => f.status === 'Operating')).length;
        document.getElementById('sc-fab-provinces').textContent = fabProvinces + '/31';
        middleLabelEl.textContent = 'Provinces with Active Fabs';
        secondaryEl.removeAttribute('title');

        if (metricKeys.includes('fab_capacity')) {
            const totalFab = provinces.reduce((s, p) => s + metricValue(p, 'fab_capacity'), 0);
            primaryEl.textContent = totalFab.toLocaleString();
            primaryLabelEl.textContent = 'Total Fab Capacity (KWPM)';

            const ucFabs = provinces.reduce((s, p) =>
                s + (p.fabs ? p.fabs.filter(f => f.status === 'Under Construction').length : 0), 0);
            secondaryEl.textContent = ucFabs;
            secondaryLabelEl.textContent = 'Fabs Under Construction';
        } else if (metricKeys.includes('ic_revenue')) {
            const totalIC = provinces.reduce((s, p) => s + metricValue(p, 'ic_revenue'), 0);
            primaryEl.textContent = '\u00a5' + Math.round(totalIC).toLocaleString() + 'B';
            primaryLabelEl.textContent = 'Total IC Revenue (B CNY)';

            const totalAI = provinces.reduce((s, p) =>
                s + (p.ai_compute ? Number(p.ai_compute.ai_companies || 0) : 0), 0);
            secondaryEl.textContent = totalAI.toLocaleString();
            secondaryLabelEl.textContent = 'Total AI Companies';
        } else {
            const primaryMetric = metricKeys[1] || metricKeys[0];
            const secondaryMetric = metricKeys[2] || metricKeys[0];
            const primaryTotal = provinces.reduce((s, p) => s + metricValue(p, primaryMetric), 0);
            const secondaryAvg = provinces.reduce((s, p) => s + metricValue(p, secondaryMetric), 0) / provinces.length;
            primaryEl.textContent = metricMeta[primaryMetric].format(Math.round(primaryTotal * 10) / 10);
            primaryLabelEl.textContent = 'Total ' + metricMeta[primaryMetric].label;
            secondaryEl.textContent = metricMeta[secondaryMetric].format(Math.round(secondaryAvg * 10) / 10);
            secondaryLabelEl.textContent = 'Avg ' + metricMeta[secondaryMetric].label;
        }

        // Top province
        const topMetric = metricKeys.includes('composite_score') ? 'composite_score' : metricKeys[0];
        const top = Object.entries(provinceData)
            .sort((a, b) => metricValue(b[1], topMetric) - metricValue(a[1], topMetric))[0];
        if (top) {
            document.getElementById('sc-top-province').textContent =
                top[1].name_en + ' (' + metricMeta[topMetric].format(metricValue(top[1], topMetric)) + ')';
            topProvinceLabelEl.textContent = 'Top Province (' + metricMeta[topMetric].short + ')';
        }
    }

    // Update metric summary
    function updateMetricSummary() {
        if (!metricMeta[activeMetric]) return;
        const values = Object.values(provinceData).map(p => metricValue(p, activeMetric));
        if (!values.length) return;
        const avg = values.reduce((a, b) => a + b, 0) / values.length;
        const max = Math.max(...values);
        document.getElementById('metric-avg').textContent = metricMeta[activeMetric].format(Math.round(avg * 10) / 10);
        document.getElementById('metric-max').textContent = metricMeta[activeMetric].format(max);
    }

    // Update legend
    function updateLegend() {
        if (!metricMeta[activeMetric]) return;
        const max = getMaxValue(activeMetric);
        const bar = document.getElementById('legend-bar');
        const stops = [];
        for (let i = 0; i <= 10; i++) {
            const t = i / 10;
            stops.push(saColorInterpolator(t) + ' ' + (t * 100) + '%');
        }
        bar.style.background = 'linear-gradient(to right, ' + stops.join(', ') + ')';
        document.getElementById('legend-label').textContent = '0';
        document.getElementById('legend-max-label').textContent = metricMeta[activeMetric].format(max);
    }

    // Recolor map
    function recolor(transition) {
        colorScale = makeColorScale(activeMetric);
        const sel = transition ? paths.transition().duration(400).ease(d3.easeCubicOut) : paths;
        sel.attr('fill', d => {
            const adcode = String(d.properties.adcode);
            const p = provinceData[adcode];
            return p ? colorScale(metricValue(p, activeMetric)) : '#141e30';
        });

        // Update glow classes
        const max = getMaxValue(activeMetric);
        paths.each(function(d) {
            const adcode = String(d.properties.adcode);
            const p = provinceData[adcode];
            const el = d3.select(this);
            el.classed('glow-high', false).classed('glow-mid', false);
            if (p) {
                const ratio = metricValue(p, activeMetric) / max;
                if (ratio > 0.7) el.classed('glow-high', true);
                else if (ratio > 0.4) el.classed('glow-mid', true);
            }
        });

        updateLegend();
        updateMetricSummary();
    }

    // Build rankings table
    function buildRankings() {
        if (!activeMetric || !metricMeta[activeMetric] || !metricKeys.length) return;
        const allMetricMaxes = {};
        metricKeys.forEach(k => {
            allMetricMaxes[k] = getMaxValue(k);
        });

        const sorted = Object.entries(provinceData)
            .sort((a, b) => metricValue(b[1], activeMetric) - metricValue(a[1], activeMetric));
        sortedProvinces = sorted.map(([ac]) => ac);

        document.getElementById('ranking-metric-label').textContent = metricMeta[activeMetric].label;

        const tbody = document.getElementById('rankings-body');
        tbody.innerHTML = sorted.map(([adcode, p], i) => {
            const v = metricValue(p, activeMetric);
            const max = allMetricMaxes[activeMetric];
            const pct = max > 0 ? (v / max * 100) : 0;
            const highlighted = adcode === selectedAdcode ? 'highlighted' : '';
            const tierClass = i < 5 ? 'tier-gold' : (i < 10 ? 'tier-silver' : '');

            // Mini bars for all metrics
            const miniBars = metricKeys.map(k => {
                const mv = metricValue(p, k);
                const mmax = allMetricMaxes[k];
                const mpct = mmax > 0 ? (mv / mmax * 100) : 0;
                const isActive = k === activeMetric;
                const color = isActive ? '#f0b429' : '#3a3a5e';
                return '<td class="px-4 py-2 text-center"><div class="w-full flex items-center justify-center" title="' +
                    metricMeta[k].label + ': ' + metricMeta[k].format(mv) + '">' +
                    '<div class="mini-metric-bar ' + (isActive ? 'active-metric' : '') +
                    '" style="width:' + Math.max(mpct, 2) + '%; background:' + color + '; max-width:40px;"></div></div></td>';
            });

            return '<tr class="rank-row border-b border-sa-border/30 cursor-pointer ' + highlighted + ' ' + tierClass + '"' +
                ' data-adcode="' + adcode + '"' +
                ' onmouseenter="window._highlightProvince(\'' + adcode + '\')"' +
                ' onmouseleave="window._unhighlightProvince(\'' + adcode + '\')"' +
                ' onclick="window._selectProvince(\'' + adcode + '\')">' +
                '<td class="px-4 py-2 text-sa-muted">' + (i + 1) + '</td>' +
                '<td class="px-4 py-2 text-white font-medium">' + p.name_en +
                ' <span class="text-sa-muted text-xs">' + p.name_cn + '</span></td>' +
                '<td class="px-4 py-2 text-sa-muted text-xs">' + p.region + '</td>' +
                miniBars.join('') +
                '<td class="px-4 py-2 text-right">' +
                '<div class="flex items-center justify-end gap-2">' +
                '<span class="text-sa-cyan font-medium">' + fmtValue(adcode, activeMetric) + '</span>' +
                '<div class="w-20 bg-sa-bg rounded-full h-1.5">' +
                '<div class="bg-sa-gold rounded-full h-1.5" style="width:' + pct + '%"></div>' +
                '</div></div></td></tr>';
        }).join('');
    }

    function buildFundingScatter() {
        const container = document.getElementById('scatter-container');
        if (!container) return;
        const width = container.clientWidth || 1200;
        const height = container.clientHeight || 560;
        const margin = { top: 24, right: 30, bottom: 60, left: 76 };

        const rows = Object.entries(provinceData).map(([adcode, p]) => ({
            adcode,
            province: p,
            name_en: p.name_en,
            name_cn: p.name_cn,
            totalFunding: metricValue(p, 'funding_total_b_cny'),
            semiFunding: metricValue(p, 'funding_semi_b_cny'),
            aiFunding: metricValue(p, 'funding_ai_b_cny'),
            score: metricValue(p, 'composite_score'),
        }));
        if (!rows.length) return;

        const xMax = Math.max(...rows.map(r => r.totalFunding), 1);
        const yMax = Math.max(...rows.map(r => r.score), 1);
        const rMax = Math.max(...rows.map(r => r.semiFunding + r.aiFunding), 1);
        const scoreColor = makeColorScale('composite_score');
        const x = d3.scaleLinear().domain([0, xMax * 1.05]).range([margin.left, width - margin.right]);
        const y = d3.scaleLinear().domain([0, yMax * 1.08]).range([height - margin.bottom, margin.top]);
        const radius = d3.scaleSqrt().domain([0, rMax]).range([4, 16]);

        scatterSvg.selectAll('*').remove();
        scatterSvg.attr('viewBox', '0 0 ' + width + ' ' + height)
            .attr('width', width)
            .attr('height', height);

        const xTicks = x.ticks(6);
        const yTicks = y.ticks(6);
        scatterSvg.append('g')
            .selectAll('line')
            .data(yTicks)
            .join('line')
            .attr('x1', margin.left)
            .attr('x2', width - margin.right)
            .attr('y1', d => y(d))
            .attr('y2', d => y(d))
            .attr('stroke', '#252547')
            .attr('stroke-width', 1);

        scatterSvg.append('g')
            .selectAll('line')
            .data(xTicks)
            .join('line')
            .attr('x1', d => x(d))
            .attr('x2', d => x(d))
            .attr('y1', margin.top)
            .attr('y2', height - margin.bottom)
            .attr('stroke', '#1e1e3d')
            .attr('stroke-width', 0.6);

        scatterSvg.append('g')
            .attr('transform', 'translate(0,' + (height - margin.bottom) + ')')
            .call(d3.axisBottom(x).ticks(6).tickFormat(v => '\u00a5' + Math.round(v) + 'B'))
            .call(g => g.selectAll('text').attr('fill', '#8888aa').attr('font-size', '11px'))
            .call(g => g.selectAll('path,line').attr('stroke', '#3a3a5e'));

        scatterSvg.append('g')
            .attr('transform', 'translate(' + margin.left + ',0)')
            .call(d3.axisLeft(y).ticks(6))
            .call(g => g.selectAll('text').attr('fill', '#8888aa').attr('font-size', '11px'))
            .call(g => g.selectAll('path,line').attr('stroke', '#3a3a5e'));

        scatterSvg.append('text')
            .attr('x', width / 2)
            .attr('y', height - 18)
            .attr('text-anchor', 'middle')
            .attr('fill', '#8888aa')
            .attr('font-size', '12px')
            .text('Total Funding (B CNY)');

        scatterSvg.append('text')
            .attr('transform', 'rotate(-90)')
            .attr('x', -(height / 2))
            .attr('y', 18)
            .attr('text-anchor', 'middle')
            .attr('fill', '#8888aa')
            .attr('font-size', '12px')
            .text('Overall Score');

        const dotGroup = scatterSvg.append('g').attr('class', 'scatter-dots');
        dotGroup.selectAll('circle')
            .data(rows)
            .join('circle')
            .attr('class', 'scatter-dot')
            .attr('data-adcode', d => d.adcode)
            .attr('cx', d => x(d.totalFunding))
            .attr('cy', d => y(d.score))
            .attr('r', d => radius(d.semiFunding + d.aiFunding))
            .attr('fill', d => scoreColor(d.score))
            .attr('fill-opacity', 0.85)
            .attr('stroke', '#0f0f23')
            .attr('stroke-width', 1.2)
            .on('mousemove', function(event, d) {
                scatterTooltip.classList.add('visible');
                scatterTooltip.style.left = (event.clientX + 12) + 'px';
                scatterTooltip.style.top = (event.clientY - 16) + 'px';
                scatterTooltip.innerHTML =
                    '<div class="text-white font-semibold text-sm">' + escapeHtml(d.name_en) + ' <span class="text-sa-muted text-xs">' + escapeHtml(d.name_cn) + '</span></div>' +
                    '<div class="text-sa-cyan text-xs mt-1">Total Funding: \u00a5' + Math.round(d.totalFunding).toLocaleString() + 'B</div>' +
                    '<div class="text-sa-muted text-xs">Semi: \u00a5' + Math.round(d.semiFunding).toLocaleString() + 'B | AI: \u00a5' + Math.round(d.aiFunding).toLocaleString() + 'B</div>' +
                    '<div class="text-sa-muted text-xs">Score: ' + d.score + '</div>';
            })
            .on('mouseleave', function() {
                scatterTooltip.classList.remove('visible');
            })
            .on('click', function(event, d) {
                openPanel(d.adcode);
            });

        scatterSvg.append('g')
            .selectAll('text')
            .data(rows.slice().sort((a, b) => (b.totalFunding + b.score) - (a.totalFunding + a.score)).slice(0, 10))
            .join('text')
            .attr('x', d => x(d.totalFunding) + radius(d.semiFunding + d.aiFunding) + 4)
            .attr('y', d => y(d.score) - 2)
            .attr('fill', '#c0c0d0')
            .attr('font-size', '10px')
            .text(d => d.name_en);
    }

    // Bidirectional highlighting: table row -> map path
    window._highlightProvince = function(adcode) {
        d3.selectAll('.province-path').filter(d => String(d.properties.adcode) === adcode)
            .raise()
            .attr('stroke', '#00D9FF')
            .attr('stroke-width', 2);
        d3.selectAll('.scatter-dot').filter(function() { return this.getAttribute('data-adcode') === adcode; })
            .attr('stroke', '#00D9FF')
            .attr('stroke-width', 2.5);
    };

    window._unhighlightProvince = function(adcode) {
        d3.selectAll('.province-path').filter(d => String(d.properties.adcode) === adcode)
            .attr('stroke', adcode === selectedAdcode ? '#f0b429' : '#5a5a7e')
            .attr('stroke-width', adcode === selectedAdcode ? 2.5 : 1.2);
        d3.selectAll('.scatter-dot').filter(function() { return this.getAttribute('data-adcode') === adcode; })
            .attr('stroke', '#0f0f23')
            .attr('stroke-width', 1.2);
    };

    // Open full-screen province modal
    function openPanel(adcode) {
        selectedAdcode = adcode;
        provinceModal.classList.remove('hidden');
        syncBodyScrollLock();
        d3.selectAll('.province-path').classed('selected', false)
            .attr('stroke', '#5a5a7e').attr('stroke-width', 1.2);
        d3.selectAll('.province-path')
            .filter(d => String(d.properties.adcode) === adcode)
            .classed('selected', true)
            .attr('stroke', '#f0b429').attr('stroke-width', 2.5);
        htmx.ajax('GET', '/api/province/' + adcode, {target: '#province-modal-content', swap: 'innerHTML'});
        buildRankings();
        focusIndex = sortedProvinces.indexOf(adcode);
    }

    window.closePanel = function() {
        provinceModal.classList.add('hidden');
        provinceModalContent.innerHTML = '';
        syncBodyScrollLock();
        selectedAdcode = null;
        focusIndex = -1;
        d3.selectAll('.province-path').classed('selected', false)
            .attr('stroke', '#5a5a7e').attr('stroke-width', 1.2);
        buildRankings();
    };

    window._selectProvince = function(adcode) {
        if (activeView === 'table') {
            setView('split');
        }
        openPanel(adcode);
    };

    // Cluster annotations data
    const clusters = [
        { label: 'YANGTZE DELTA', lat: 30.5, lng: 120.5, provinces: ['310000', '320000', '330000'] },
        { label: 'PEARL RIVER DELTA', lat: 22.5, lng: 113.5, provinces: ['440000'] },
        { label: 'BEIJING-TIANJIN', lat: 40.5, lng: 117.5, provinces: ['110000', '120000'] },
        { label: 'WUHAN MEMORY', lat: 29.5, lng: 114.0, provinces: ['420000'] },
        { label: "XI'AN NAND", lat: 34.0, lng: 108.0, provinces: ['610000'] },
    ];

    // Province labels for tier 1/2 provinces
    const provinceLabels = {
        '310000': { short: 'SH',  lat: 31.2, lng: 121.5 },
        '110000': { short: 'BJ',  lat: 39.9, lng: 116.4 },
        '440000': { short: 'GD',  lat: 23.1, lng: 113.3 },
        '320000': { short: 'JS',  lat: 32.9, lng: 119.5 },
        '420000': { short: 'HB',  lat: 30.6, lng: 112.2 },
        '340000': { short: 'AH',  lat: 31.8, lng: 117.2 },
        '610000': { short: 'SN',  lat: 34.3, lng: 109.0 },
        '330000': { short: 'ZJ',  lat: 29.2, lng: 120.0 },
        '510000': { short: 'SC',  lat: 30.6, lng: 104.0 },
        '120000': { short: 'TJ',  lat: 39.1, lng: 117.2 },
        '350000': { short: 'FJ',  lat: 26.0, lng: 118.3 },
        '210000': { short: 'LN',  lat: 41.8, lng: 123.4 },
    };

    // Keyboard nav
    document.addEventListener('keydown', function(e) {
        // Escape closes modal(s)
        if (e.key === 'Escape') {
            if (!storiesModal.classList.contains('hidden')) {
                closeStoriesModal();
                return;
            }
            if (!companiesModal.classList.contains('hidden')) {
                closeCompaniesModal();
                return;
            }
            if (!provinceModal.classList.contains('hidden')) {
                window.closePanel();
            }
            return;
        }
        // Number keys 1-6 switch metrics
        if (e.key >= '1' && e.key <= '6' && !e.ctrlKey && !e.metaKey && !e.altKey) {
            const idx = parseInt(e.key) - 1;
            if (idx < metricKeys.length) {
                const tab = document.querySelector('[data-index="' + e.key + '"]');
                if (tab) tab.click();
            }
            return;
        }
        // Arrow keys cycle provinces
        if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
            e.preventDefault();
            if (!sortedProvinces.length) return;
            if (e.key === 'ArrowDown') {
                focusIndex = Math.min(focusIndex + 1, sortedProvinces.length - 1);
            } else {
                focusIndex = Math.max(focusIndex - 1, 0);
            }
            openPanel(sortedProvinces[focusIndex]);
            // Scroll row into view
            const row = document.querySelector('[data-adcode="' + sortedProvinces[focusIndex] + '"]');
            if (row) row.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        }
    });

    // Init
    function rewindGeometry(geometry) {
        if (!geometry) return geometry;
        if (geometry.type === 'Polygon') {
            return {
                type: 'Polygon',
                coordinates: geometry.coordinates.map(ring => ring.slice().reverse()),
            };
        }
        if (geometry.type === 'MultiPolygon') {
            return {
                type: 'MultiPolygon',
                coordinates: geometry.coordinates.map(poly =>
                    poly.map(ring => ring.slice().reverse())
                ),
            };
        }
        return geometry;
    }

    function keepPrimaryProvincePolygon(feature) {
        if (!feature) return feature;
        const geometry = feature.geometry;
        if (!geometry || geometry.type !== 'MultiPolygon' || !Array.isArray(geometry.coordinates) || !geometry.coordinates.length) {
            return feature;
        }

        const candidates = geometry.coordinates.map(poly => {
            const polygon = { type: 'Polygon', coordinates: poly };
            return {
                poly,
                area: d3.geoArea(polygon),
                centroid: d3.geoCentroid(polygon),
            };
        });

        const adcode = String(feature?.properties?.adcode || '');
        let source = candidates;
        if (adcode === '460000') {
            const nearHainan = candidates.filter(c => {
                const lon = c.centroid[0];
                const lat = c.centroid[1];
                return lon >= 108 && lon <= 113 && lat >= 18 && lat <= 22;
            });
            if (nearHainan.length) source = nearHainan;
        }

        let largest = null;
        let maxArea = -1;
        source.forEach(candidate => {
            if (candidate.area > maxArea) {
                maxArea = candidate.area;
                largest = candidate.poly;
            }
        });

        if (!largest) return feature;
        return {
            ...feature,
            geometry: { type: 'Polygon', coordinates: [largest[0]] },
        };
    }

    Promise.all([
        d3.json('/static/china-provinces-source.topo.json'),
        fetch('/api/provinces').then(r => r.json()),
        fetch('/api/company-profiles').then(r => r.json()).catch(() => ({ semi_companies: [], ai_companies: [] })),
    ]).then(([topology, data, companyData]) => {
        provinceData = data;
        window.provinceData = data;
        buildMetricModels();

        const container = document.getElementById('map-container');
        const width = container.clientWidth || 1200;
        const height = container.clientHeight || 700;

        svg.attr('width', width)
           .attr('height', height)
           .attr('viewBox', '0 0 ' + width + ' ' + height);

        const geojson = topojson.feature(topology, topology.objects.provinces);
        const provinceFeatures = geojson.features
            .filter(f => provinceData[String(f.properties.adcode)])
            .map(f => ({ ...f, geometry: rewindGeometry(f.geometry) }))
            .map(keepPrimaryProvincePolygon);

        // Filter to mainland provinces only for fitSize calculation
        const mainlandFeatures = provinceFeatures.filter(f => {
            const ac = String(f.properties.adcode);
            return ac !== '100000_JD' && ac !== '710000' && ac !== '810000' && ac !== '820000';
        });
        const mainlandGeo = { type: 'FeatureCollection', features: mainlandFeatures };

        // Auto-fit projection to container with padding
        const projection = d3.geoMercator()
            .fitExtent([[40, 20], [width - 120, height - 20]], mainlandGeo);

        const path = d3.geoPath().projection(projection);
        const hainanFeature = provinceFeatures.find(f => String(f.properties.adcode) === '460000');
        let clipBottomY = height;
        if (hainanFeature) {
            const hainanBounds = path.bounds(hainanFeature);
            clipBottomY = Math.min(height, hainanBounds[1][1] + 8);
        }
        const clipId = 'china-mainland-clip';
        svg.append('defs')
            .append('clipPath')
            .attr('id', clipId)
            .append('rect')
            .attr('x', 0)
            .attr('y', 0)
            .attr('width', width)
            .attr('height', clipBottomY);

        const g = svg.append('g')
            .attr('clip-path', 'url(#' + clipId + ')');

        paths = g.selectAll('path')
            .data(provinceFeatures)
            .join('path')
            .attr('d', path)
            .attr('class', 'province-path')
            .on('mouseover', function(event, d) {
                const adcode = String(d.properties.adcode);
                const p = provinceData[adcode];
                if (!p) return;
                const rank = getRank(adcode);
                const max = getMaxValue(activeMetric);
                const val = metricValue(p, activeMetric);
                const pct = max > 0 ? (val / max * 100) : 0;

                document.getElementById('tt-name').textContent = p.name_en;
                document.getElementById('tt-cn').textContent = p.name_cn;
                document.getElementById('tt-value').textContent =
                    metricMeta[activeMetric].short + ': ' + fmtValue(adcode, activeMetric);
                document.getElementById('tt-rank').textContent =
                    rank ? '#' + rank + ' of ' + Object.keys(provinceData).length : '';
                document.getElementById('tt-bar').style.width = pct + '%';
                tooltip.classList.add('visible');

                // Highlight matching table row
                document.querySelectorAll('.rank-row').forEach(r => r.classList.remove('highlighted'));
                const row = document.querySelector('[data-adcode="' + adcode + '"]');
                if (row) row.classList.add('highlighted');
            })
            .on('mousemove', function(event) {
                const x = event.clientX + 16;
                const y = event.clientY - 20;
                tooltip.style.left = x + 'px';
                tooltip.style.top = y + 'px';
            })
            .on('mouseout', function(event, d) {
                tooltip.classList.remove('visible');
                // Restore table highlight state
                document.querySelectorAll('.rank-row').forEach(r => {
                    r.classList.toggle('highlighted', r.dataset.adcode === selectedAdcode);
                });
            })
            .on('click', function(event, d) {
                openPanel(String(d.properties.adcode));
            });

        // Province labels
        labelGroup = g.append('g').attr('class', 'province-labels');
        Object.entries(provinceLabels).forEach(([adcode, info]) => {
            const [x, y] = projection([info.lng, info.lat]);
            labelGroup.append('text')
                .attr('class', 'province-label')
                .attr('x', x)
                .attr('y', y)
                .text(info.short);
        });

        // Cluster annotations
        clusterGroup = g.append('g').attr('class', 'cluster-annotations');
        clusters.forEach(c => {
            const [x, y] = projection([c.lng, c.lat]);
            // Dashed ellipse around cluster
            clusterGroup.append('ellipse')
                .attr('cx', x)
                .attr('cy', y - 12)
                .attr('rx', 45)
                .attr('ry', 18)
                .attr('fill', 'none')
                .attr('stroke', '#8888aa')
                .attr('stroke-width', 0.5)
                .attr('stroke-dasharray', '3,3')
                .attr('opacity', 0.4);

            clusterGroup.append('text')
                .attr('class', 'cluster-label')
                .attr('x', x)
                .attr('y', y - 22)
                .text(c.label);
        });

        buildFabEntities();
        populateFabStatusFilter();
        buildFabEntityTable();
        buildTopStories();
        buildCompanyProfiles(companyData);
        renderStoriesHeading();
        renderCompanyHeading();
        setLens('industrial');
        buildFundingScatter();

        // Fab entity controls
        fabSearchInput.addEventListener('input', buildFabEntityTable);
        fabStatusFilter.addEventListener('change', buildFabEntityTable);
        fabSortSelect.addEventListener('change', buildFabEntityTable);

        storiesOpenBtn.addEventListener('click', openStoriesModal);
        storiesCloseBtn.addEventListener('click', closeStoriesModal);
        storiesBackdrop.addEventListener('click', closeStoriesModal);
        companiesOpenBtn.addEventListener('click', openCompaniesModal);
        companiesCloseBtn.addEventListener('click', closeCompaniesModal);
        companiesBackdrop.addEventListener('click', closeCompaniesModal);
        companiesSearch.addEventListener('input', renderCompanyList);
        companiesTypeFilter.addEventListener('change', renderCompanyList);
        provinceBackdrop.addEventListener('click', window.closePanel);
        storiesSearch.addEventListener('input', renderStoriesList);
        storiesTagFilter.addEventListener('change', renderStoriesList);
        document.querySelectorAll('#stories-mode-tabs [data-stories-mode]').forEach(btn => {
            btn.addEventListener('click', () => {
                storiesMode = btn.dataset.storiesMode || 'feed';
                document.querySelectorAll('#stories-mode-tabs [data-stories-mode]').forEach(b => {
                    b.classList.toggle('active', b === btn);
                });
                renderStoriesList();
            });
        });
        storiesList.addEventListener('click', (event) => {
            const button = event.target.closest('.story-open-item');
            if (!button) return;
            const adcode = button.dataset.adcode;
            if (!adcode) return;
            closeStoriesModal();
            setView('split');
            openPanel(adcode);
        });
        companiesList.addEventListener('click', (event) => {
            const button = event.target.closest('.company-open-item');
            if (!button) return;
            const adcode = button.dataset.adcode;
            if (!adcode) return;
            closeCompaniesModal();
            setView('split');
            openPanel(adcode);
        });

        // Zoom (wheel is disabled to preserve normal page scroll behavior)
        const zoom = d3.zoom()
            .scaleExtent([1, 8])
            .on('zoom', (event) => g.attr('transform', event.transform));
        svg.call(zoom);
        svg.on('wheel.zoom', null);

        // Double-click to reset zoom
        svg.on('dblclick.zoom', null);
        svg.on('dblclick', () => {
            svg.transition().duration(500).call(zoom.transform, d3.zoomIdentity);
        });

        // Lens switching
        document.querySelectorAll('#lens-tabs .lens-tab').forEach(tab => {
            tab.addEventListener('click', () => setLens(tab.dataset.lens));
        });

        // Layout view switching
        document.querySelectorAll('#view-tabs .view-tab').forEach(tab => {
            tab.addEventListener('click', () => setView(tab.dataset.view));
        });
        setView('split');

    }).catch(err => {
        console.error('Map init failed:', err);
        document.getElementById('map-container').innerHTML =
            '<p style="color:red;padding:20px;">Map failed to load: ' + err.message + '</p>';
    });
})();
</script>
{% endblock %}
